import React, { useState, useEffect, useCallback, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore } from 'firebase/firestore';

// --- Global Variable Access ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
const apiKey = ""; // Global API Key - System injects key here

// --- UTILITIES FOR AUDIO/IMAGE ---

// Helper to write string to DataView for WAV header
const writeString = (view, offset, string) => {
  for (let i = 0; i < string.length; i++) {
    view.setUint8(offset + i, string.charCodeAt(i));
  }
};

// Convert Base64 PCM to WAV Blob URL
const pcmToWav = (base64PCM, sampleRate = 24000) => {
  try {
    const binaryString = atob(base64PCM);
    const len = binaryString.length;
    const buffer = new ArrayBuffer(len);
    const view = new Uint8Array(buffer);
    for (let i = 0; i < len; i++) {
      view[i] = binaryString.charCodeAt(i);
    }
    const pcmData = new Int16Array(buffer); // Assuming 16-bit PCM

    const wavHeader = new ArrayBuffer(44);
    const headerView = new DataView(wavHeader);

    writeString(headerView, 0, 'RIFF');
    headerView.setUint32(4, 36 + pcmData.byteLength, true);
    writeString(headerView, 8, 'WAVE');
    writeString(headerView, 12, 'fmt ');
    headerView.setUint32(16, 16, true); 
    headerView.setUint16(20, 1, true); 
    headerView.setUint16(22, 1, true); 
    headerView.setUint32(24, sampleRate, true); 
    headerView.setUint32(28, sampleRate * 2, true); 
    headerView.setUint16(32, 2, true); 
    headerView.setUint16(34, 16, true); 
    writeString(headerView, 36, 'data');
    headerView.setUint32(40, pcmData.byteLength, true);

    const wavBlob = new Blob([headerView, pcmData], { type: 'audio/wav' });
    return URL.createObjectURL(wavBlob);
  } catch (e) {
    console.error("PCM conversion error:", e);
    return null;
  }
};

// Helper to convert simple Markdown to JSX/HTML
const renderMarkdown = (markdownText) => {
  if (!markdownText || typeof markdownText !== 'string') return null;
  let html = markdownText;
  html = html.replace(/^### (.*$)/gim, '</h3><h3 class="text-xl font-bold text-indigo-600 dark:text-indigo-400 mt-4 mb-2">$1');
  html = html.replace(/^## (.*$)/gim, '</h2><h2 class="text-2xl font-bold text-indigo-700 dark:text-indigo-300 mt-6 mb-3">$1');
  html = html.replace(/^# (.*$)/gim, '</h1><h1 class="text-3xl font-extrabold text-indigo-800 dark:text-indigo-200 mb-4">$1');
  html = html.replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>');
  const parts = html.split('\n\n');
  const processedHtml = parts.map((p, index) => {
      if (p.startsWith('<h1') || p.startsWith('<h2') || p.startsWith('<h3')) {
          return p;
      }
      p = p.replace(/^- (.*)/gim, '<li class="ml-4 list-disc">$1</li>');
      p = p.replace(/<br>/g, ''); 
      if (p.includes('<li')) {
          return `<ul class="list-inside space-y-1">${p}</ul>`;
      }
      return `<p class="mb-3">${p}</p>`;
  }).join('');
  return <div dangerouslySetInnerHTML={{ __html: processedHtml.replace(/<p><\/p>/g, '').trim() }} />;
};


// --- JSON SCHEMA DEFINITIONS ---

const RESPONSE_SCHEMA_SCRIPTURE = {
  type: "OBJECT",
  properties: {
    scriptures: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          reference: { type: "STRING" },
          text: { type: "STRING" },
          translation: { type: "STRING" }
        }
      }
    },
    prayer: { type: "STRING" }
  }
};

const RESPONSE_SCHEMA_STUDY = {
  type: "OBJECT",
  properties: {
    study_title: { type: "STRING" },
    verses: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          reference: { type: "STRING" },
          text: { type: "STRING" },
          translation: { type: "STRING" }
        }
      }
    },
    plan_sections: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          section_title: { type: "STRING" },
          content: { type: "STRING" }
        }
      }
    }
  }
};

const RESPONSE_SCHEMA_SERMON = {
  type: "OBJECT",
  properties: {
    title: { type: "STRING" },
    main_scripture: { type: "STRING" },
    introduction: { type: "STRING" },
    main_points: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          point_title: { type: "STRING" },
          content: { type: "STRING" },
          supporting_verse: { type: "STRING" }
        }
      }
    },
    conclusion: { type: "STRING" }
  }
};

const RESPONSE_SCHEMA_TRIVIA = {
  type: "OBJECT",
  properties: {
    question: { type: "STRING" },
    options: { type: "ARRAY", items: { type: "STRING" } },
    correct_index: { type: "INTEGER" },
    reference: { type: "STRING" },
    explanation: { type: "STRING" }
  }
};

const RESPONSE_SCHEMA_APOLOGETICS = {
  type: "OBJECT",
  properties: {
    intro: { type: "STRING" },
    scriptural_basis: { type: "STRING" },
    reasoning: { type: "STRING" },
    conclusion: { type: "STRING" }
  }
};

const RESPONSE_SCHEMA_EXEGETICAL = {
  type: "OBJECT",
  properties: {
    reference: { type: "STRING" },
    historical_context: { type: "STRING" },
    literary_context: { type: "STRING" },
    original_language_insights: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          original_word: { type: "STRING" },
          transliteration: { type: "STRING" },
          meaning: { type: "STRING" },
          significance: { type: "STRING" }
        }
      }
    },
    verse_analysis: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          verse: { type: "STRING" },
          commentary: { type: "STRING" }
        }
      }
    },
    theological_summary: { type: "STRING" }
  }
};

const RESPONSE_SCHEMA_TOPICAL_COMMENTARY = {
  type: "OBJECT",
  properties: {
    topic: { type: "STRING" },
    definition: { type: "STRING" },
    biblical_development: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          era: { type: "STRING" },
          summary: { type: "STRING" },
          key_references: { type: "STRING" }
        }
      }
    },
    modern_application: { type: "STRING" },
    related_topics: { type: "ARRAY", items: { type: "STRING" } }
  }
};

const RESPONSE_SCHEMA_LITERAL = {
  type: "OBJECT",
  properties: {
    reference: { type: "STRING" },
    original_text_snippet: { type: "STRING" },
    literal_segments: {
        type: "ARRAY",
        items: {
            type: "OBJECT",
            properties: {
                text: { type: "STRING" },
                parsing: { type: "STRING" },
                significance: { type: "STRING" }
            }
        }
    },
    notes: { type: "STRING" }
  }
};

const RESPONSE_SCHEMA_DICTIONARY = {
  type: "OBJECT",
  properties: {
    item: { type: "STRING" },
    definition: { type: "STRING" },
    significance: { type: "STRING" },
    testament: { type: "STRING" },
    references: { type: "ARRAY", items: { type: "STRING" } },
    visual_prompt: { type: "STRING" }
  }
};

const RESPONSE_SCHEMA_HYMN = {
  type: "OBJECT",
  properties: {
    title: { type: "STRING" },
    style: { type: "STRING" },
    lyrics: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          section_type: { type: "STRING" },
          lines: { type: "STRING" }
        }
      }
    }
  }
};

const RESPONSE_SCHEMA_METAPHOR = {
  type: "OBJECT",
  properties: {
    concept: { type: "STRING" },
    analogies: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          title: { type: "STRING" },
          story: { type: "STRING" },
          connection: { type: "STRING" } 
        }
      }
    }
  }
};

const RESPONSE_SCHEMA_QUIET_TIME = {
  type: "OBJECT",
  properties: {
    title: { type: "STRING" },
    total_duration: { type: "STRING" },
    steps: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          duration: { type: "STRING" }, 
          activity: { type: "STRING" }, 
          content: { type: "STRING" } 
        }
      }
    }
  }
};

const RESPONSE_SCHEMA_DEBATE = {
  type: "OBJECT",
  properties: {
    topic: { type: "STRING" },
    participants: { type: "STRING" },
    dialogue: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          speaker: { type: "STRING" },
          text: { type: "STRING" }
        }
      }
    },
    conclusion_summary: { type: "STRING" },
    historical_verdict: { type: "STRING" }
  }
};

const RESPONSE_SCHEMA_MEMORIZATION = {
  type: "OBJECT",
  properties: {
    reference: { type: "STRING" },
    text: { type: "STRING" },
    mnemonic_device: { type: "STRING" },
    visualization_prompt: { type: "STRING" },
    fill_in_the_blank: { type: "STRING" }
  }
};

const RESPONSE_SCHEMA_NAMES = {
  type: "OBJECT",
  properties: {
    category: { type: "STRING" },
    names: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          name: { type: "STRING" },
          original_word: { type: "STRING" },
          meaning: { type: "STRING" },
          context: { type: "STRING" }
        }
      }
    }
  }
};

const RESPONSE_SCHEMA_EVENT = {
  type: "OBJECT",
  properties: {
    theme_title: { type: "STRING" },
    scripture_focus: { type: "STRING" },
    icebreaker: { type: "STRING" },
    decor_ideas: { type: "STRING" },
    schedule: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          time: { type: "STRING" },
          activity: { type: "STRING" },
          description: { type: "STRING" }
        }
      }
    }
  }
};

const RESPONSE_SCHEMA_REMIX = {
  type: "OBJECT",
  properties: {
    title: { type: "STRING" },
    original_reference: { type: "STRING" },
    style_description: { type: "STRING" },
    story_content: { type: "STRING" }
  }
};

const RESPONSE_SCHEMA_CONFLICT = {
  type: "OBJECT",
  properties: {
    analysis: { type: "STRING" },
    biblical_principles: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          principle: { type: "STRING" },
          verse: { type: "STRING" }
        }
      }
    },
    action_plan: {
      type: "ARRAY",
      items: { type: "STRING" }
    },
    conversation_script: { type: "STRING" },
    prayer_for_peace: { type: "STRING" }
  }
};

const RESPONSE_SCHEMA_PROVERB = {
  type: "OBJECT",
  properties: {
    proverb_reference: { type: "STRING" },
    proverb_text: { type: "STRING" },
    meaning: { type: "STRING" },
    biblical_examples: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          example_title: { type: "STRING" },
          description: { type: "STRING" },
          reference: { type: "STRING" }
        }
      }
    },
    practical_application: { type: "STRING" }
  }
};

const RESPONSE_SCHEMA_EPISTLE = {
  type: "OBJECT",
  properties: {
    occasion: { type: "STRING" },
    subject_line: { type: "STRING" },
    message_body: { type: "STRING" },
    scripture_included: { type: "STRING" }
  }
};

const RESPONSE_SCHEMA_ILLUSTRATION = {
  type: "OBJECT",
  properties: {
    concept: { type: "STRING" },
    illustrations: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          title: { type: "STRING" },
          source_type: { type: "STRING" }, // e.g., Historical, Scientific, Biography
          content: { type: "STRING" },
          application: { type: "STRING" }
        }
      }
    }
  }
};

const RESPONSE_SCHEMA_TIMELINE = {
  type: "OBJECT",
  properties: {
    subject: { type: "STRING" },
    events: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          approx_time: { type: "STRING" },
          event_description: { type: "STRING" },
          scripture_ref: { type: "STRING" }
        }
      }
    }
  }
};

// --- NEW SCHEMA FOR SUMMARY ---
const RESPONSE_SCHEMA_SUMMARY = {
  type: "OBJECT",
  properties: {
    reference: { type: "STRING" },
    key_takeaways: {
      type: "ARRAY",
      items: { type: "STRING" }
    },
    life_applications: {
      type: "ARRAY",
      items: { type: "STRING" }
    }
  }
};

// --- NEW SCHEMA FOR GEM FINDER ---
const RESPONSE_SCHEMA_GEM = {
  type: "OBJECT",
  properties: {
    person: { type: "STRING" },
    reference: { type: "STRING" },
    gems: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          quote: { type: "STRING" },
          source: { type: "STRING" }, // e.g., "Sermon on the Mount Commentary", "Mere Christianity"
          context: { type: "STRING" }, // Brief context explaining when/why it was said
          themes: { type: "STRING" }
        }
      }
    }
  }
};

// --- NEW SCHEMA FOR INTERLINEAR ---
const RESPONSE_SCHEMA_INTERLINEAR = {
  type: "OBJECT",
  properties: {
    reference: { type: "STRING" },
    original_language: { type: "STRING" }, // "Hebrew" or "Greek"
    words: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          original: { type: "STRING" },
          transliteration: { type: "STRING" },
          english: { type: "STRING" },
          part_of_speech: { type: "STRING" },
          morphology: { type: "STRING" }, // e.g. "V-A-I-3S"
          definition: { type: "STRING" },
          significance: { type: "STRING" } // The "fun stuff"
        }
      }
    }
  }
};

// --- NEW SCHEMA FOR YOUTH GROUP PLAN ---
const RESPONSE_SCHEMA_YOUTH_PLAN = {
  type: "OBJECT",
  properties: {
    theme: { type: "STRING" },
    scripture_focus: { type: "STRING" },
    icebreaker: {
      type: "OBJECT",
      properties: {
        name: { type: "STRING" },
        instructions: { type: "STRING" },
        materials_needed: { type: "STRING" }
      }
    },
    lesson_outline: {
      type: "ARRAY",
      items: { type: "STRING" }
    },
    discussion_questions: {
      type: "ARRAY",
      items: { type: "STRING" }
    },
    activity: {
      type: "OBJECT",
      properties: {
        name: { type: "STRING" },
        description: { type: "STRING" }
      }
    },
    closing_prayer: { type: "STRING" }
  }
};

// --- NEW SCHEMA FOR TYPES OF CHRIST ---
const RESPONSE_SCHEMA_TYPES_OF_CHRIST = {
  type: "OBJECT",
  properties: {
    overview: { type: "STRING" },
    types_list: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          type_name: { type: "STRING" },
          ot_shadow: { type: "STRING" },
          ot_reference: { type: "STRING" },
          nt_fulfillment: { type: "STRING" },
          nt_reference: { type: "STRING" },
          theological_significance: { type: "STRING" }
        }
      }
    }
  }
};

// --- CONSTANTS ---

const REMIX_STYLES = [
  "Dr. Seuss",
  "Film Noir Detective",
  "Cyberpunk Sci-Fi",
  "Breaking News Report",
  "Shakespearean Drama",
  "Tech Support Log",
  "Spaghetti Western",
  "Space Opera"
];

const USEFUL_LINKS = [
    { name: "Bible Gateway", url: "https://www.biblegateway.com" },
    { name: "Blue Letter Bible", url: "https://www.blueletterbible.org" },
    { name: "Bible Hub", url: "https://biblehub.com" },
    { name: "Got Questions", url: "https://www.gotquestions.org" },
    { name: "OpenBible.info", url: "https://www.openbible.info" },
    { name: "Christian Classics Ethereal Library", url: "https://www.ccel.org" },
    { name: "SermonIndex.net", url: "https://www.sermonindex.net" },
    { name: "SermonAudio.com", url: "https://www.sermonaudio.com" }
];

const PRAYER_SECTIONS = [
    { key: 'praise', title: "1. Praise & Adoration", placeholder: "e.g., I adore you for your faithfulness..." },
    { key: 'kingdom', title: "2. Kingdom & Will", placeholder: "e.g., I pray your will is done..." },
    { key: 'provision', title: "3. Daily Provision", placeholder: "e.g., I ask for resources..." },
    { key: 'receiving_forgiveness', title: "4. Forgiveness (Receiving)", placeholder: "e.g., I confess my impatience..." },
    { key: 'giving_forgiveness', title: "5. Forgiveness (Giving)", placeholder: "e.g., Help me forgive..." },
    { key: 'temptation', title: "6. Protection from Temptation", placeholder: "e.g., Guide me away from..." },
    { key: 'deliverance', title: "7. Deliverance from Evil", placeholder: "e.g., Protect my family..." }
];

const EVANGELISM_PERSONAS = [
    { id: 'atheist', label: 'Scientifically Minded Atheist', prompt: 'You are a friendly but skeptical atheist who values empirical evidence.' },
    { id: 'agnostic', label: 'Curious Agnostic', prompt: 'You are an agnostic. You are polite and inquisitive.' },
    { id: 'new_age', label: 'New Age Spiritualist', prompt: 'You are a spiritual person who believes in "energy" but dislikes organized religion.' },
    { id: 'nominal', label: 'Cultural Christian', prompt: 'You identify as Christian culturally but doubt biblical authority.' },
    { id: 'mormon', label: 'LDS Missionary', prompt: 'You are a devout Mormon missionary. You are polite and use Christian terminology but hold LDS theology.' },
    { id: 'witness', label: 'Jehovah\'s Witness', prompt: 'You are a zealous Jehovah\'s Witness.' },
    { id: 'muslim', label: 'Devout Muslim', prompt: 'You are a respectful Muslim who honors Jesus as a prophet but denies his divinity.' }
];

const BIBLICAL_CHARACTERS = [
    // --- New Testament: The Apostles & Leaders ---
    { id: 'paul', label: 'Apostle Paul', prompt: 'You are the Apostle Paul. You are zealous, intellectual, and deeply theological. Speak as you wrote in your epistles, focusing on grace, faith, and the church.' },
    { id: 'peter', label: 'Simon Peter', prompt: 'You are Simon Peter, the fisherman and disciple. You are passionate, sometimes impulsive, but deeply loyal to Christ. Speak about your experiences walking with Jesus.' },
    { id: 'john', label: 'John the Beloved', prompt: 'You are John, the disciple whom Jesus loved. You wrote the Gospel of John and Revelation. Speak of love, light, the Word made flesh, and deep theological truth.' },
    { id: 'andrew', label: 'Andrew', prompt: 'You are Andrew, the first disciple called. You are known for bringing people to Jesus, including your brother Peter. Speak of humility and the joy of introduction.' },
    { id: 'james_zeb', label: 'James (Son of Zebedee)', prompt: 'You are James, son of Zebedee, a Son of Thunder. You were the first apostle martyred. Speak of passion, glory, and the cost of discipleship.' },
    { id: 'philip', label: 'Philip', prompt: 'You are Philip. You are practical and eager. Speak of seeing the Father through the Son and inviting others to "Come and see".' },
    { id: 'bartholomew', label: 'Bartholomew (Nathanael)', prompt: 'You are Bartholomew (Nathanael). You are an Israelite in whom there is no deceit. Speak of sincerity and seeing greater things than these.' },
    { id: 'thomas', label: 'Doubting Thomas', prompt: 'You are Thomas. You are skeptical but deeply committed once convinced. Speak of the journey from honest doubt to declaring "My Lord and my God!"' },
    { id: 'matthew', label: 'Matthew (Levi)', prompt: 'You are Matthew, the Tax Collector. You left a lucrative career to follow Jesus. Speak of mercy, the Kingdom of Heaven, and Jesus fulfilling prophecy.' },
    { id: 'james_alph', label: 'James (Son of Alphaeus)', prompt: 'You are James the Less. You are faithful and obscure to history but known to God. Speak of quiet faithfulness and service in the background.' },
    { id: 'thaddaeus', label: 'Thaddaeus (Jude)', prompt: 'You are Thaddaeus (Judas, son of James). You asked the Lord how he would manifest to the disciples and not the world. Speak of intimacy with Christ.' },
    { id: 'simon_zealot', label: 'Simon the Zealot', prompt: 'You are Simon the Zealot. You once sought political revolution but found the true King. Speak of passion channeled for the Kingdom of God.' },
    { id: 'matthias', label: 'Matthias', prompt: 'You are Matthias, chosen to replace Judas. You were a witness from the baptism of John to the ascension. Speak of God\'s sovereignty in election.' },
    { id: 'mary_mag', label: 'Mary Magdalene', prompt: 'You are Mary Magdalene. You were healed of demons and were the first to see the Risen Lord. Speak with deep gratitude and devotion.' },
    { id: 'mary_mother', label: 'Mary (Mother of Jesus)', prompt: 'You are Mary, mother of Jesus. You are humble, reflective, and treasure things in your heart. Speak of magnifying the Lord.' },
    { id: 'luke', label: 'Luke the Physician', prompt: 'You are Luke. You are detailed, compassionate, and observant. Speak of healing, the marginalized, and the certainty of the Gospel.' },
    { id: 'priscilla', label: 'Priscilla', prompt: 'You are Priscilla, a teacher and leader in the early church. Speak of hospitality, explaining the way of God more accurately, and serving alongside Aquila.' },
    { id: 'john_baptist', label: 'John the Baptist', prompt: 'You are John the Baptist. You are intense and urgent. Speak of repentance, humility, and preparing the way for the Lamb of God.' },

    // --- Old Testament Figures ---
    { id: 'adam', label: 'Adam', prompt: 'You are Adam, the first man. You walked in Eden. Speak of creation, naming the animals, the fall, and the hope of the seed of the woman.' },
    { id: 'eve', label: 'Eve', prompt: 'You are Eve, the mother of all living. Speak of the garden, the deception, and the promise of future redemption.' },
    { id: 'noah', label: 'Noah', prompt: 'You are Noah. You speak of obedience, enduring in a wicked generation, and the covenant of the rainbow.' },
    { id: 'abraham', label: 'Abraham', prompt: 'You are Abraham, the Father of Many Nations. You speak of faith, covenant, and trusting God even when the path is unknown.' },
    { id: 'sarah', label: 'Sarah', prompt: 'You are Sarah. You speak of God\'s faithfulness in doing the impossible and laughing with joy at His promises.' },
    { id: 'joseph_ot', label: 'Joseph (OT)', prompt: 'You are Joseph, son of Jacob. You speak of dreams, forgiveness, and how God turns evil intentions into good for His people.' },
    { id: 'jacob', label: 'Jacob (Israel)', prompt: 'You are Jacob. You wrestled with God and prevailed. Speak of blessings, birthrights, struggles, and God\'s faithfulness to his covenant.' },
    { id: 'moses', label: 'Moses', prompt: 'You are Moses, the Lawgiver. You are humble yet authoritative. Speak of the Exodus, the Law, and leading a difficult people.' },
    { id: 'joshua', label: 'Joshua', prompt: 'You are Joshua. You led Israel into the Promised Land. Speak of courage, strength, and choosing this day whom you will serve.' },
    { id: 'deborah', label: 'Deborah', prompt: 'You are Deborah, a Judge and Prophetess. You led Israel when men were afraid. Speak of victory, praise, and arising as a mother in Israel.' },
    { id: 'gideon', label: 'Gideon', prompt: 'You are Gideon. You were a mighty warrior who needed signs. Speak of overcoming fear and God saving by many or by few.' },
    { id: 'samson', label: 'Samson', prompt: 'You are Samson. You had great strength but great weakness. Speak of God\'s power working despite human failure and final redemption.' },
    { id: 'ruth', label: 'Ruth', prompt: 'You are Ruth. You speak of loyalty, redemption, and finding refuge under the wings of the God of Israel.' },
    { id: 'samuel', label: 'Samuel', prompt: 'You are Samuel, the Prophet. You listened to God\'s voice as a child. Speak of obedience, anointing kings, and that to obey is better than sacrifice.' },
    { id: 'david', label: 'King David', prompt: 'You are King David, the Psalmist. You are a warrior and a poet. Speak with emotion, referencing the Psalms, God\'s faithfulness, and repentance.' },
    { id: 'solomon', label: 'King Solomon', prompt: 'You are King Solomon. You are the wisest man who ever lived, yet honest about vanity. Speak in proverbs and reflections on life\'s meaning.' },
    { id: 'elijah', label: 'Elijah', prompt: 'You are Elijah the Prophet. You speak with fiery zeal against idolatry and of the still, small voice of God.' },
    { id: 'isaiah', label: 'Isaiah', prompt: 'You are Isaiah the Prophet. You speak in poetic, soaring language about the holiness of God and the coming Messiah.' },
    { id: 'jeremiah', label: 'Jeremiah', prompt: 'You are Jeremiah, the Weeping Prophet. You spoke truth to a rebellious people. Speak of the New Covenant and God\'s plans to prosper, not harm.' },
    { id: 'ezekiel', label: 'Ezekiel', prompt: 'You are Ezekiel. You saw visions of God\'s glory and the valley of dry bones. Speak of the Spirit bringing life and the sovereignty of God.' },
    { id: 'daniel', label: 'Daniel', prompt: 'You are Daniel. You served in Babylon with integrity. Speak of prayer, prophecy, and God\'s sovereignty over earthly kingdoms.' },
    { id: 'job', label: 'Job', prompt: 'You are Job. You suffered greatly yet trusted God. Speak of patience, the mystery of suffering, and the greatness of the Creator.' },
    { id: 'jonah', label: 'Jonah', prompt: 'You are Jonah. You tried to run from God. Speak of God\'s relentless mercy to the lost and the sign of the great fish.' },
    { id: 'esther', label: 'Queen Esther', prompt: 'You are Queen Esther. You are courageous and faithful. Speak about providence, courage in the face of danger, and saving your people.' },
    { id: 'nehemiah', label: 'Nehemiah', prompt: 'You are Nehemiah, the Cupbearer and Builder. You speak of prayer, leadership, rebuilding what is broken, and standing firm against opposition.' }
];

const AVAILABLE_TRANSLATIONS = ['NIV', 'KJV', 'ESV', 'NASB', 'CSB', 'NKJV', 'NLT', 'RSV', 'NRSV', 'ASV', 'WEB', 'AMP', 'MSG']; 

// --- HELPER COMPONENTS ---

// ✨ NEW: Reusable Microphone Button Component
const MicButton = ({ onTranscript }) => {
  const [isListening, setIsListening] = useState(false);
  const [isSupported, setIsSupported] = useState(false);
  const recognitionRef = useRef(null);

  useEffect(() => {
    if (typeof window !== 'undefined' && (window.SpeechRecognition || window.webkitSpeechRecognition)) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.continuous = false; // Stop after one sentence/pause
      recognition.interimResults = false;
      recognition.lang = 'en-US';

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        if (transcript) onTranscript(transcript);
        setIsListening(false);
      };

      recognition.onerror = (event) => {
        console.error("Speech recognition error", event.error);
        setIsListening(false);
      };

      recognition.onend = () => setIsListening(false);
      recognitionRef.current = recognition;
      setIsSupported(true);
    }
  }, [onTranscript]);

  const toggleListening = () => {
    if (!recognitionRef.current) {
        alert("Speech recognition not supported in this browser.");
        return;
    }
    if (isListening) {
      recognitionRef.current.stop();
    } else {
      recognitionRef.current.start();
      setIsListening(true);
    }
  };

  if (!isSupported) return null;

  return (
    <button
      type="button"
      onClick={toggleListening}
      className={`p-2 rounded-full transition-colors duration-200 ${isListening ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-transparent text-gray-500 hover:text-gray-700 dark:text-gray-500 dark:hover:text-gray-300'}`}
      title="Dictate"
    >
      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path fillRule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clipRule="evenodd" />
      </svg>
    </button>
  );
};

const PrayerSection = ({ prayer, onSpeak, speaking }) => {
  if (!prayer) return null;
  return (
    <div className="mt-8 p-6 bg-yellow-50 dark:bg-yellow-900 border-l-4 border-yellow-500 rounded-lg shadow-inner transition-colors duration-300 relative">
      <div className="flex justify-between items-start mb-3">
        <h2 className="text-xl font-bold text-yellow-800 dark:text-yellow-400 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
          Suggested Prayer
        </h2>
        <button onClick={() => onSpeak(prayer)} disabled={speaking} className={`flex items-center text-xs font-semibold px-3 py-1 rounded-full transition-all ${speaking ? 'bg-gray-200 text-gray-500' : 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200'}`}>
          {speaking ? "Speaking..." : "Listen"}
        </button>
      </div>
      <p className="text-gray-700 dark:text-gray-300 whitespace-pre-line leading-relaxed italic">{prayer}</p>
    </div>
  );
};

const MetaphorSection = ({ result }) => {
  if (!result || !result.analogies || !Array.isArray(result.analogies)) return null;
  return (
    <div className="mt-8 space-y-6">
      <h2 className="text-3xl font-extrabold text-violet-900 dark:text-violet-300 text-center">
        Analogies for: {result.concept}
      </h2>
      <div className="grid gap-6">
        {result.analogies.map((item, index) => (
          <div key={index} className="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-violet-100 dark:border-violet-900 overflow-hidden">
             <div className="bg-violet-600 p-3 text-white font-bold text-lg">
                Option {index + 1}: {item.title}
             </div>
             <div className="p-5">
               <p className="text-gray-800 dark:text-gray-200 mb-4 font-medium leading-relaxed">
                 {item.story}
               </p>
               <div className="bg-violet-50 dark:bg-gray-700 p-3 rounded-lg border-l-4 border-violet-400">
                  <span className="text-xs font-bold uppercase text-violet-600 dark:text-violet-300 block mb-1">Connection</span>
                  <p className="text-sm text-gray-700 dark:text-gray-300 italic">
                    {item.connection}
                  </p>
               </div>
             </div>
          </div>
        ))}
      </div>
    </div>
  );
};

const QuietTimeSection = ({ result }) => {
  if (!result || !result.steps || !Array.isArray(result.steps)) return null;
  return (
    <div className="mt-8">
      <div className="bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800 rounded-xl p-6">
        <div className="flex justify-between items-center mb-6 border-b border-emerald-200 dark:border-emerald-800 pb-4">
           <h2 className="text-2xl font-bold text-emerald-800 dark:text-emerald-400">
             {result.title}
           </h2>
           <span className="bg-emerald-100 dark:bg-emerald-800 text-emerald-700 dark:text-emerald-200 px-3 py-1 rounded-full text-sm font-semibold">
             {result.total_duration}
           </span>
        </div>
        <div className="space-y-0">
          {result.steps.map((step, index) => (
             <div key={index} className="flex relative pb-8 last:pb-0">
                <div className="flex-shrink-0 w-16 text-right mr-4 font-mono text-sm font-bold text-emerald-600 dark:text-emerald-500 pt-1">
                   {step.duration}
                </div>
                {index !== result.steps.length - 1 && (
                  <div className="absolute top-4 left-[4.5rem] -ml-px h-full w-0.5 bg-emerald-200 dark:bg-emerald-800"></div>
                )}
                <div className="flex-grow">
                   <div className="relative">
                      <div className="absolute -left-6 mt-1.5 w-3 h-3 rounded-full bg-emerald-400 dark:bg-emerald-600 border-2 border-white dark:border-gray-900"></div>
                      <h4 className="font-bold text-gray-900 dark:text-white mb-1">{step.activity}</h4>
                      <p className="text-gray-600 dark:text-gray-300 text-sm leading-relaxed whitespace-pre-line">
                        {step.content}
                      </p>
                   </div>
                </div>
             </div>
          ))}
        </div>
      </div>
    </div>
  );
};

const DebateSection = ({ result }) => {
  if (!result || !result.dialogue || !Array.isArray(result.dialogue)) return null;
  return (
    <div className="mt-8 bg-white dark:bg-gray-800 rounded-xl shadow-xl overflow-hidden border border-gray-200 dark:border-gray-700">
       <div className="bg-gray-800 text-white p-4 text-center">
          <h2 className="text-xl font-bold uppercase tracking-wider">Theological Dialogue</h2>
          <p className="text-gray-400 text-sm">
            {typeof result.participants === 'string' ? result.participants : 'Participants'} on "{result.topic}"
          </p>
       </div>
       <div className="p-6 space-y-4 max-h-[500px] overflow-y-auto bg-gray-50 dark:bg-gray-900">
          {result.dialogue.map((line, idx) => {
             const isSpeaker1 = idx % 2 === 0;
             return (
               <div key={idx} className={`flex ${isSpeaker1 ? 'justify-start' : 'justify-end'}`}>
                  <div className={`max-w-[85%] rounded-lg p-4 shadow-sm border ${isSpeaker1 ? 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 rounded-tl-none' : 'bg-blue-50 dark:bg-blue-900/20 border-blue-100 dark:border-blue-800 rounded-tr-none'}`}>
                     <span className="text-xs font-bold uppercase mb-1 block opacity-60">
                       {line.speaker}
                     </span>
                     <p className="text-gray-800 dark:text-gray-200 font-serif leading-relaxed">
                       {line.text}
                     </p>
                  </div>
               </div>
             );
          })}
       </div>
       <div className="p-4 bg-gray-100 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
          <h4 className="text-xs font-bold uppercase text-gray-500 mb-2">Summary</h4>
          <p className="text-sm text-gray-700 dark:text-gray-300 italic mb-4">
            {result.conclusion_summary}
          </p>
          {result.historical_verdict && (
            <div className="bg-amber-50 dark:bg-amber-900/20 p-4 rounded-lg border-l-4 border-amber-600">
                <h4 className="text-xs font-bold uppercase text-amber-800 dark:text-amber-400 mb-1 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Historical Verdict
                </h4>
                <p className="text-sm text-gray-800 dark:text-gray-200 font-serif leading-relaxed">
                    {result.historical_verdict}
                </p>
            </div>
          )}
       </div>
    </div>
  );
};

const HymnSection = ({ result, onSpeak, speaking }) => {
  if (!result || !result.lyrics || !Array.isArray(result.lyrics)) return null;
  const fullText = result.lyrics.map(l => l.lines).join(' ');

  return (
    <div className="mt-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-rose-200 dark:border-rose-800 overflow-hidden">
      <div className="bg-gradient-to-r from-rose-500 to-pink-600 p-6 text-white">
        <div className="flex justify-between items-start">
          <div>
            <span className="text-xs uppercase font-bold tracking-widest opacity-80">{result.style}</span>
            <h2 className="text-3xl font-bold mt-1">{result.title}</h2>
          </div>
          <button onClick={() => onSpeak(fullText)} disabled={speaking} className="bg-white/20 hover:bg-white/30 text-white px-3 py-1 rounded-full text-xs font-bold transition">
             {speaking ? "Singing..." : "Listen to Lyrics"}
          </button>
        </div>
      </div>
      <div className="p-6 space-y-6">
        {result.lyrics.map((section, idx) => (
          <div key={idx} className={`${section.section_type.toLowerCase().includes('chorus') ? 'bg-rose-50 dark:bg-rose-900/20 p-4 rounded-lg border-l-4 border-rose-400' : ''}`}>
             <h4 className="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase mb-2">{section.section_type}</h4>
             <p className="whitespace-pre-line font-serif text-lg text-gray-800 dark:text-gray-200 leading-relaxed">
               {section.lines}
             </p>
          </div>
        ))}
      </div>
    </div>
  );
};

const SymbolismSection = ({ result }) => {
  if (!result) return null;
  return (
    <div className="mt-8 p-6 bg-indigo-50 dark:bg-gray-800 border border-indigo-200 dark:border-indigo-800 rounded-xl shadow-md">
       <h2 className="text-2xl font-bold text-indigo-900 dark:text-indigo-300 mb-4 flex items-center">
         <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
         Symbolic Analysis
       </h2>
       <div className="prose prose-indigo dark:prose-invert max-w-none">
          {renderMarkdown(result)}
       </div>
       <p className="mt-4 text-xs text-gray-500 italic border-t pt-2">
         *Note: This is an AI interpretation of biblical symbols. It is not prophecy or definitive spiritual counsel.
       </p>
    </div>
  );
};

// ✨ UPDATED: Character Chat Section with better scrolling and compact styling
const CharacterChatSection = ({ chatHistory, character, chatLoading, onSend }) => {
    const [message, setMessage] = useState('');
    const chatEndRef = useRef(null);

    useEffect(() => {
        // scrollIntoView with block: 'nearest' helps prevent jarring jumps if the message is tall
        chatEndRef.current?.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }, [chatHistory, chatLoading]);

    const handleSubmit = (e) => {
        e.preventDefault();
        if (!message.trim()) return;
        onSend(message);
        setMessage('');
    };

    return (
        <div className="mt-8 flex flex-col h-[600px] border border-amber-200 dark:border-amber-700 rounded-xl overflow-hidden shadow-lg bg-stone-50 dark:bg-stone-900">
            {/* Header */}
            <div className="bg-gradient-to-r from-amber-700 to-orange-700 p-3 shadow-md z-10 flex justify-between items-center">
                <h3 className="text-white font-serif font-bold text-base flex items-center">
                    Chat with {character.label}
                </h3>
                {/* Visual indicator of who you are talking to */}
                <span className="text-xs bg-black/20 text-white px-2 py-1 rounded-full">{character.label}</span>
            </div>

            {/* Chat Area */}
            <div className="flex-grow overflow-y-auto p-4 space-y-3 bg-stone-100 dark:bg-stone-800 bg-[url('https://www.transparenttextures.com/patterns/paper.png')]">
                {chatHistory.length === 0 && (
                     <div className="text-center text-stone-500 dark:text-stone-400 mt-10 p-4">
                         <p className="mb-2 italic">"Grace and peace to you..."</p>
                         <p className="text-xs">Ask {character.label} about their life, writings, or faith.</p>
                     </div>
                )}
                
                {chatHistory.map((msg, index) => {
                    const isUser = msg.role === 'user';
                    return (
                        <div key={index} className={`flex w-full ${isUser ? 'justify-end' : 'justify-start'}`}>
                            <div 
                                className={`max-w-[90%] rounded-xl px-4 py-2 shadow-sm border text-xs sm:text-sm font-serif ${
                                    isUser 
                                    ? 'bg-amber-700 text-white rounded-br-none' 
                                    : 'bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-bl-none border border-amber-200 dark:border-gray-600'
                                }`}
                            >
                                <p className="leading-relaxed whitespace-pre-wrap">{msg.text}</p>
                            </div>
                        </div>
                    );
                })}
                
                {chatLoading && (
                     <div className="flex justify-start w-full">
                        <div className="bg-white dark:bg-gray-700 rounded-2xl rounded-bl-none px-4 py-2 border border-amber-200 dark:border-gray-600 flex items-center space-x-2">
                             <div className="w-1.5 h-1.5 bg-amber-400 rounded-full animate-bounce" style={{animationDelay: '0ms'}}></div>
                             <div className="w-1.5 h-1.5 bg-amber-400 rounded-full animate-bounce" style={{animationDelay: '150ms'}}></div>
                             <div className="w-1.5 h-1.5 bg-amber-400 rounded-full animate-bounce" style={{animationDelay: '300ms'}}></div>
                        </div>
                     </div>
                )}
                <div ref={chatEndRef} />
            </div>

            {/* Input Area */}
            <form onSubmit={handleSubmit} className="bg-white dark:bg-gray-800 p-3 border-t border-amber-200 dark:border-gray-700 flex gap-2">
                <div className="relative flex-grow">
                   <input 
                        type="text" 
                        value={message}
                        onChange={(e) => setMessage(e.target.value)}
                        placeholder={`Ask ${character.label}...`}
                        disabled={chatLoading}
                        className="w-full p-2 pr-9 rounded-lg border border-amber-300 dark:border-gray-600 bg-stone-50 dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-amber-500 outline-none transition-all font-serif text-sm"
                    />
                    <div className="absolute right-1 top-1">
                       <MicButton onTranscript={(text) => setMessage(prev => (prev ? prev + ' ' : '') + text)} />
                    </div>
                </div>
                <button 
                    type="submit" 
                    disabled={chatLoading || !message.trim()}
                    className={`px-4 py-2 rounded-lg font-bold text-white text-sm transition-all shadow-md ${
                        chatLoading || !message.trim()
                        ? 'bg-gray-400 cursor-not-allowed'
                        : 'bg-amber-700 hover:bg-amber-800 active:bg-amber-900'
                    }`}
                >
                    Send
                </button>
            </form>
        </div>
    );
};

const LiteralTranslationSection = ({ results, onSpeak, speaking }) => {
    const [activeParsing, setActiveParsing] = useState(null);
    const explanationRef = useRef(null);
    useEffect(() => { if (activeParsing && explanationRef.current) explanationRef.current.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, [activeParsing]);
    if (!results) return null;
    return (
        <div className="mt-8 space-y-6">
            <div className="border-b-2 border-slate-400 pb-4"><h2 className="text-3xl font-extrabold text-slate-800 dark:text-slate-200 mb-1">Literal Translation</h2></div>
            {results.original_text_snippet && <div className="bg-slate-50 dark:bg-slate-900 p-4 rounded-lg text-right font-serif text-slate-500 dark:text-slate-500 text-sm italic">Original: "{results.original_text_snippet}..."</div>}
            <div className="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
                <div className="mb-4 leading-loose text-lg font-serif">
                     {results.literal_segments.map((seg, idx) => (<React.Fragment key={idx}><span className="text-gray-900 dark:text-gray-100">{seg.text} </span>{seg.parsing && (<button onClick={() => setActiveParsing(activeParsing === seg ? null : seg)} className={`inline-block mx-1 px-1.5 py-0.5 text-[10px] font-bold uppercase tracking-wider rounded border border-transparent ${activeParsing === seg ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-300'}`}>{seg.parsing}</button>)}</React.Fragment>))}
                </div>
                {activeParsing && (<div ref={explanationRef} className="mt-6 mb-4 p-5 bg-indigo-50 dark:bg-indigo-900/30 border-l-4 border-indigo-500 rounded-r-lg shadow-sm"><h4 className="text-sm font-bold text-indigo-800 dark:text-indigo-300 uppercase">Significance of [{activeParsing.parsing}]</h4><p className="text-base text-gray-800 dark:text-gray-200 leading-relaxed font-medium">{activeParsing.significance}</p></div>)}
            </div>
        </div>
    );
};

const ExegeticalSection = ({ results, onSpeak, speaking }) => {
    if (!results) return null;
    return (
        <div className="mt-8 space-y-6">
            <div className="border-b-2 border-teal-800 dark:border-teal-400 pb-4"><h2 className="text-3xl font-extrabold text-teal-900 dark:text-teal-200 mb-1">Exegetical Commentary</h2><p className="text-lg text-teal-700 dark:text-teal-300 font-serif italic">{results.reference}</p></div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="bg-white dark:bg-gray-700 p-5 rounded-lg shadow-md border-l-4 border-teal-600"><h3 className="font-bold text-teal-800 dark:text-teal-200 mb-2 uppercase text-xs tracking-wider">Historical Context</h3><p className="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">{results.historical_context}</p></div><div className="bg-white dark:bg-gray-700 p-5 rounded-lg shadow-md border-l-4 border-teal-600"><h3 className="font-bold text-teal-800 dark:text-teal-200 mb-2 uppercase text-xs tracking-wider">Literary Context</h3><p className="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">{results.literary_context}</p></div></div>
            {results.original_language_insights && results.original_language_insights.length > 0 && (<div className="bg-stone-50 dark:bg-gray-800 p-6 rounded-xl border border-stone-200 dark:border-gray-600"><h3 className="text-xl font-bold text-stone-800 dark:text-stone-200 mb-4">Original Language Insights</h3><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{results.original_language_insights.map((item, idx) => (<div key={idx} className="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm"><div className="flex justify-between items-baseline mb-1"><span className="text-2xl font-serif text-teal-800 dark:text-teal-300 font-bold">{item.original_word}</span><span className="text-xs text-gray-500 dark:text-gray-400 font-mono">/{item.transliteration}/</span></div><p className="text-sm font-semibold text-gray-900 dark:text-gray-100 mb-2">{item.meaning}</p><p className="text-xs text-gray-600 dark:text-gray-300 italic leading-snug">{item.significance}</p></div>))}</div></div>)}
            <div className="bg-teal-900 text-white p-6 rounded-xl shadow-lg"><div className="flex justify-between items-center mb-2"><h3 className="text-lg font-bold opacity-90">Theological Summary</h3><button onClick={() => onSpeak(results.theological_summary)} disabled={speaking} className="text-xs text-teal-200 hover:text-white">Listen</button></div><p className="leading-relaxed opacity-95 font-serif">{results.theological_summary}</p></div>
        </div>
    );
};

const TopicalCommentarySection = ({ results, onVerseClick, onSpeak, speaking }) => {
    if (!results) return null;
    return (
        <div className="mt-8 space-y-8">
            <div className="text-center">
                <h2 className="text-4xl font-extrabold text-sky-900 dark:text-sky-300 mb-2">{results.topic || "Commentary"}</h2>
            </div>
            <div className="bg-sky-50 dark:bg-gray-800 border-l-4 border-sky-500 p-6 rounded-r-lg">
                <h3 className="font-bold text-sky-800 dark:text-sky-300 mb-2">Definition</h3>
                <p className="text-lg text-gray-800 dark:text-gray-200">{results.definition || "No definition available."}</p>
            </div>
            <div className="space-y-4">
                {results.biblical_development && Array.isArray(results.biblical_development) ? (
                    results.biblical_development.map((era, idx) => (
                        <div key={idx} className="pl-4 border-l-2 border-sky-300">
                            <h4 className="font-bold">{era.era}</h4>
                            <p>{era.summary}</p>
                        </div>
                    ))
                ) : (
                    <p className="text-gray-500 italic p-4">Detailed historical development not available for this topic.</p>
                )}
            </div>
        </div>
    );
};

const DictionarySection = ({ results, onVerseClick, onSpeak, speaking, onGenerateImage, generatingImage, generatedImage }) => {
    if (!results) return null;
    return (
        <div className="mt-8 space-y-6">
            <div className="border-b-2 border-fuchsia-300 pb-4"><h2 className="text-4xl font-extrabold">{results.item}</h2></div>
            <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border-l-4 border-fuchsia-500"><p className="text-lg">{results.definition}</p></div>
            <div className="bg-gradient-to-br from-fuchsia-900 to-purple-900 text-white p-6 rounded-xl shadow-xl relative">
                <h3 className="text-2xl font-bold mb-2">Historical Illustration</h3>
                {!generatedImage && (<button onClick={() => onGenerateImage(results.visual_prompt)} disabled={generatingImage} className="bg-white text-fuchsia-900 px-5 py-3 rounded-lg font-bold">{generatingImage ? "Painting..." : "Generate Illustration"}</button>)}
                {generatedImage && <img src={generatedImage} alt={results.item} className="rounded-lg shadow-2xl border-4 border-white/20 max-h-64 object-cover mt-4" />}
            </div>
        </div>
    );
};

const ScriptureSection = ({ scriptures, title, onVerseClick }) => (
  <div className="mt-6 p-6 bg-white dark:bg-gray-700 rounded-xl shadow-md">
    <h2 className="text-xl font-bold text-indigo-700 dark:text-indigo-300 mb-4">{title || 'Guiding Scriptures'}</h2>
    <ul className="space-y-4">{scriptures.map((s, index) => (<li key={index} className="border-b border-indigo-100 dark:border-indigo-600 pb-4 cursor-pointer hover:bg-indigo-50 dark:hover:bg-gray-600 rounded-md p-2" onClick={() => onVerseClick(s.reference, s.translation)}><p className="font-semibold text-indigo-600 dark:text-indigo-400 text-lg mb-1">{s.reference}</p><p className="text-gray-700 dark:text-gray-300 italic">"{s.text}"</p></li>))}</ul>
  </div>
);

const TriviaSection = ({ results, onVerseClick, onNextQuestion, loadingNext }) => {
  const [selectedIndex, setSelectedIndex] = useState(null);
  const [isRevealed, setIsRevealed] = useState(false);
  useEffect(() => { setSelectedIndex(null); setIsRevealed(false); }, [results]);
  if (!results) return null;
  const handleOptionClick = (index) => { if (isRevealed) return; setSelectedIndex(index); setIsRevealed(true); };
  const isCorrect = selectedIndex === results.correct_index;
  return (
    <div className="mt-8 max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-xl overflow-hidden border border-cyan-200">
        <div className="bg-gradient-to-r from-cyan-600 to-blue-600 p-6 text-center"><h3 className="text-xl font-bold text-white">{results.question}</h3></div>
        <div className="p-6 grid gap-4">{results.options.map((option, index) => (<button key={index} onClick={() => handleOptionClick(index)} disabled={isRevealed} className={`p-4 rounded-lg border-2 text-left font-semibold ${isRevealed ? (index === results.correct_index ? "bg-green-100 border-green-500 text-green-800" : index === selectedIndex ? "bg-red-100 border-red-500 text-red-800" : "bg-gray-50 opacity-60") : "bg-white hover:border-cyan-500"}`}>{option}</button>))}</div>
        {isRevealed && <div className="p-6 border-t bg-gray-50"><h4 className="font-bold">{isCorrect ? "Correct!" : "Nice try!"}</h4><p>{results.explanation}</p><button onClick={onNextQuestion} disabled={loadingNext} className="mt-4 w-full py-2 bg-cyan-600 text-white rounded-lg">Next Question</button></div>}
    </div>
  );
};

const ApologeticsSection = ({ results, onSpeak, speaking }) => {
    if (!results) return null;
    return (
        <div className="mt-8 space-y-6">
            <h2 className="text-2xl font-bold text-blue-800 dark:text-blue-300">Theologian's Response</h2>
            <div className="bg-blue-50 dark:bg-blue-900/30 p-5 rounded-lg border-l-4 border-blue-400"><p>{results.intro}</p></div>
            <div className="bg-white dark:bg-gray-700 p-5 rounded-lg border"><p className="italic">"{results.scriptural_basis}"</p></div>
            <div className="bg-white dark:bg-gray-700 p-5 rounded-lg border"><p>{results.reasoning}</p></div>
            <div className="bg-gray-100 dark:bg-gray-800 p-5 rounded-lg"><p>{results.conclusion}</p></div>
        </div>
    );
};

const ParableSection = ({ result, onSpeak, speaking }) => {
    if (!result) return null;
    return (
        <div className="mt-8 p-8 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 rounded-xl">
             <div className="flex justify-between items-start mb-6"><h2 className="text-3xl font-serif font-bold text-amber-900 dark:text-amber-500">A Modern Parable</h2><button onClick={() => onSpeak(result)} disabled={speaking} className="bg-amber-100 text-amber-900 px-4 py-2 rounded-full text-sm font-bold">{speaking ? "Narrating..." : "Read Aloud"}</button></div>
             <div className="prose prose-lg font-serif text-gray-800 dark:text-gray-200 whitespace-pre-wrap">{result}</div>
        </div>
    );
};

const SermonOutlineSection = ({ results, onVerseClick, onSpeak, speaking, onGenerateImage, generatingImage, generatedImage, isSpurgeon = false }) => {
  if (!results) return null;
  return (
    <div className="mt-8 space-y-6">
      <div className="text-center border-b-2 pb-4"><h2 className="text-3xl font-extrabold">{results.title}</h2><p className="text-lg">{results.main_scripture}</p>{!generatedImage && (<button onClick={() => onGenerateImage(`${results.title}. Christian sermon slide.`)} disabled={generatingImage} className="mt-4 bg-purple-600 text-white px-4 py-2 rounded-full text-sm">Generate Slide</button>)}{generatedImage && <img src={generatedImage} alt="Slide" className="mt-4 rounded-xl shadow-lg max-h-64 mx-auto" />}</div>
      <div className="bg-white dark:bg-gray-700 p-6 rounded-xl border-l-4 border-purple-500"><h3 className="font-bold">Introduction</h3><p>{results.introduction}</p></div>
      <div className="space-y-4">{results.main_points && Array.isArray(results.main_points) ? results.main_points.map((point, index) => (<div key={index} className="bg-gray-50 dark:bg-gray-800 p-6 rounded-xl shadow"><h3 className="font-bold">{index + 1}. {point.point_title}</h3><p>{point.content}</p></div>)) : null}</div>
      <div className="bg-purple-900 text-white p-6 rounded-xl"><h3 className="font-bold">Conclusion</h3><p>{results.conclusion}</p></div>
    </div>
  );
};

const StudyPlanSection = ({ results, onVerseClick }) => {
  if (!results || !results.plan_sections) return null;
  return (
    <div className="mt-8">
      <h2 className="text-3xl font-extrabold text-center mb-6">{results.study_title}</h2>
      {results.verses && <div className="mb-8 p-6 bg-indigo-50 rounded-xl"><ul className="space-y-4">{results.verses.map((s, index) => (<li key={index} onClick={() => onVerseClick(s.reference, s.translation)} className="cursor-pointer font-semibold text-indigo-700">{s.reference}</li>))}</ul></div>}
      {results.plan_sections.map((section, index) => (<div key={index} className="mb-6 p-6 bg-white dark:bg-gray-700 rounded-xl shadow-lg"><h4 className="text-xl font-bold text-indigo-600">{index + 1}. {section.section_title}</h4><p>{section.content}</p></div>))}
    </div>
  );
};

const EvangelismSection = ({ chatHistory, persona, chatLoading, onSend, onGetHint, hint, hintLoading, onClearHint }) => {
    const [message, setMessage] = useState('');
    const chatEndRef = useRef(null);
    useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [chatHistory, chatLoading, hint]);
    const handleSubmit = (e) => { e.preventDefault(); if (!message.trim()) return; onSend(message); setMessage(''); if (onClearHint) onClearHint(); };
    return (
        <div className="mt-8 flex flex-col h-[600px] border rounded-xl overflow-hidden bg-gray-50 dark:bg-gray-900">
            <div className="bg-red-600 p-4"><h3 className="text-white font-bold">Simulated Conversation: {persona.label}</h3></div>
            <div className="flex-grow overflow-y-auto p-4 space-y-4 bg-gray-100 dark:bg-gray-800">{chatHistory.map((msg, index) => (<div key={index} className={`flex w-full ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[80%] rounded-2xl px-4 py-3 ${msg.role === 'user' ? 'bg-red-600 text-white' : 'bg-white text-gray-800'}`}>{msg.text}</div></div>))} <div ref={chatEndRef} /></div>
            {hint && <div className="bg-amber-50 p-3 text-sm border-t"><span className="font-bold">Hint:</span> {renderMarkdown(hint)}</div>}
            <form onSubmit={handleSubmit} className="bg-white dark:bg-gray-800 p-4 border-t flex gap-2">
                <button type="button" onClick={onGetHint} disabled={chatLoading} className="px-3 border rounded text-amber-600">Hint</button>
                <div className="relative flex-grow">
                    <input 
                        type="text" 
                        value={message} 
                        onChange={(e) => setMessage(e.target.value)} 
                        className="w-full p-3 pr-10 border rounded" 
                        placeholder="Type message..." 
                    />
                    <div className="absolute right-2 top-2">
                        <MicButton onTranscript={(text) => setMessage(prev => (prev ? prev + ' ' : '') + text)} />
                    </div>
                </div>
                <button type="submit" disabled={chatLoading} className="px-6 bg-red-600 text-white rounded font-bold">Send</button>
            </form>
        </div>
    );
};

const MemorizationSection = ({ result }) => {
  if (!result) return null;
  return (
    <div className="mt-8 space-y-6">
      <div className="bg-lime-50 dark:bg-lime-900/20 p-6 rounded-xl border border-lime-300 dark:border-lime-700">
        <h2 className="text-2xl font-bold text-lime-800 dark:text-lime-300 mb-2 text-center">{result.reference}</h2>
        <p className="text-lg text-center font-serif text-gray-800 dark:text-gray-200 mb-4">"{result.text}"</p>
        
        <div className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-lime-200 mb-4">
          <h3 className="text-xs font-bold uppercase text-lime-600 dark:text-lime-400 mb-1">Mnemonic Device</h3>
          <p className="text-gray-700 dark:text-gray-300 font-medium">{result.mnemonic_device}</p>
        </div>

        <div className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-lime-200 mb-4">
           <h3 className="text-xs font-bold uppercase text-lime-600 dark:text-lime-400 mb-1">Visualization Prompt</h3>
           <p className="text-gray-700 dark:text-gray-300 italic text-sm">{result.visualization_prompt}</p>
        </div>

        <div className="bg-lime-100 dark:bg-lime-900 p-4 rounded-lg shadow-inner">
           <h3 className="text-xs font-bold uppercase text-lime-800 dark:text-lime-200 mb-2">Quiz Yourself</h3>
           <p className="font-mono text-gray-800 dark:text-gray-200 leading-loose">{result.fill_in_the_blank}</p>
        </div>
      </div>
    </div>
  );
};

const NameGeneratorSection = ({ result }) => {
  if (!result || !result.names) return null;
  return (
    <div className="mt-8">
      <h2 className="text-2xl font-bold text-center mb-6 text-fuchsia-800 dark:text-fuchsia-300">Biblical Names for "{result.category}"</h2>
      <div className="grid gap-4 md:grid-cols-2">
        {result.names.map((n, i) => (
          <div key={i} className="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md border-l-4 border-fuchsia-500">
            <div className="flex justify-between items-baseline mb-2">
              <h3 className="text-xl font-bold text-gray-900 dark:text-white">{n.name}</h3>
              <span className="text-xs font-mono text-gray-500">{n.original_word}</span>
            </div>
            <p className="text-sm font-semibold text-fuchsia-600 dark:text-fuchsia-400 mb-2">{n.meaning}</p>
            <p className="text-sm text-gray-600 dark:text-gray-300">{n.context}</p>
          </div>
        ))}
      </div>
    </div>
  );
};

const EventPlannerSection = ({ result }) => {
  if (!result) return null;
  return (
    <div className="mt-8 space-y-6">
       <div className="bg-cyan-50 dark:bg-cyan-900/20 p-6 rounded-xl border border-cyan-200 dark:border-cyan-700 text-center">
          <h2 className="text-3xl font-extrabold text-cyan-800 dark:text-cyan-300 mb-2">{result.theme_title}</h2>
          <p className="text-lg text-gray-700 dark:text-gray-300 italic mb-4">Focus: {result.scripture_focus}</p>
          
          <div className="grid md:grid-cols-2 gap-4 text-left">
             <div className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm">
                <h4 className="font-bold text-cyan-700 dark:text-cyan-400 text-sm uppercase mb-1">Icebreaker</h4>
                <p className="text-sm">{result.icebreaker}</p>
             </div>
             <div className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm">
                <h4 className="font-bold text-cyan-700 dark:text-cyan-400 text-sm uppercase mb-1">Decor Idea</h4>
                <p className="text-sm">{result.decor_ideas}</p>
             </div>
          </div>
       </div>

       <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-200 dark:border-gray-700">
          <div className="bg-cyan-700 text-white p-3 font-bold text-center">Event Schedule</div>
          {result.schedule.map((slot, i) => (
             <div key={i} className="flex p-4 border-b last:border-0 border-gray-100 dark:border-gray-700 items-start">
                <div className="w-20 font-mono font-bold text-cyan-600 dark:text-cyan-400 text-sm pt-1">{slot.time}</div>
                <div>
                   <h4 className="font-bold text-gray-900 dark:text-white">{slot.activity}</h4>
                   <p className="text-sm text-gray-600 dark:text-gray-400">{slot.description}</p>
                </div>
             </div>
          ))}
       </div>
    </div>
  );
};

const StoryRemixSection = ({ result }) => {
  if (!result) return null;
  return (
    <div className="mt-8 space-y-6">
       <div className="bg-purple-900 text-white p-8 rounded-xl shadow-2xl relative overflow-hidden">
          <div className="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 bg-purple-500 rounded-full opacity-20 blur-3xl"></div>
          <h2 className="text-4xl font-extrabold mb-1 relative z-10">{result.title}</h2>
          <div className="flex items-center space-x-3 mb-6 relative z-10 text-purple-200">
             <span className="font-mono text-sm uppercase tracking-widest">{result.original_reference}</span>
             <span className="w-1 h-1 bg-purple-300 rounded-full"></span>
             <span className="font-bold text-sm italic">{result.style_description}</span>
          </div>
          <div className="bg-white/10 backdrop-blur-md p-6 rounded-lg border border-white/10 text-lg leading-relaxed font-medium">
             {renderMarkdown(result.story_content)}
          </div>
       </div>
    </div>
  );
};

const ConflictMediatorSection = ({ result }) => {
  if (!result) return null;
  return (
    <div className="mt-8 space-y-8">
      <div className="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-xl border-l-4 border-blue-600">
         <h3 className="text-xl font-bold text-blue-800 dark:text-blue-300 mb-2">Situation Analysis</h3>
         <p className="text-gray-800 dark:text-gray-200">{result.analysis}</p>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
         <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
            <h3 className="font-bold text-gray-500 uppercase text-xs tracking-wider mb-4">Biblical Principles</h3>
            <ul className="space-y-4">
               {result.biblical_principles.map((p, i) => (
                  <li key={i} className="flex flex-col">
                     <span className="font-bold text-gray-900 dark:text-white">{p.principle}</span>
                     <span className="text-xs text-blue-600 dark:text-blue-400 font-mono mt-1">{p.verse}</span>
                  </li>
               ))}
            </ul>
         </div>
         <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
            <h3 className="font-bold text-gray-500 uppercase text-xs tracking-wider mb-4">Action Plan</h3>
            <ol className="list-decimal list-inside space-y-3 text-gray-800 dark:text-gray-200">
               {result.action_plan.map((step, i) => (
                  <li key={i}>{step}</li>
               ))}
            </ol>
         </div>
      </div>

      <div className="bg-gray-100 dark:bg-gray-700 p-6 rounded-xl border border-gray-200 dark:border-gray-600">
         <h3 className="font-bold text-gray-900 dark:text-white mb-3">Sample Script</h3>
         <div className="bg-white dark:bg-gray-800 p-4 rounded-lg italic text-gray-700 dark:text-gray-300 border-l-2 border-gray-400">
            "{result.conversation_script}"
         </div>
      </div>

      <div className="bg-yellow-50 dark:bg-yellow-900/10 p-6 rounded-xl border border-yellow-200 dark:border-yellow-800">
          <h3 className="font-bold text-yellow-800 dark:text-yellow-500 mb-2">Prayer for Peace</h3>
          <p className="text-gray-800 dark:text-gray-200 italic">{result.prayer_for_peace}</p>
      </div>
    </div>
  );
};

const ProverbSection = ({ result }) => {
  if (!result) return null;
  return (
    <div className="mt-8 space-y-6">
      <div className="bg-amber-100 dark:bg-amber-900/30 p-6 rounded-xl border border-amber-300 dark:border-amber-700 text-center shadow-sm">
        <h2 className="text-2xl font-serif font-bold text-amber-900 dark:text-amber-500 mb-2">{result.proverb_reference}</h2>
        <p className="text-xl italic text-gray-800 dark:text-gray-200 font-serif leading-relaxed">"{result.proverb_text}"</p>
      </div>

      <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border-l-4 border-amber-500">
        <h3 className="font-bold text-gray-500 dark:text-gray-400 uppercase text-xs tracking-wider mb-2">Interpretation</h3>
        <p className="text-lg text-gray-800 dark:text-gray-200 leading-relaxed font-medium">{result.meaning}</p>
      </div>

      <div className="space-y-4">
        <h3 className="text-xl font-bold text-gray-800 dark:text-white px-2 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.247m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.247" /></svg>
            Biblical Examples
        </h3>
        {result.biblical_examples.map((ex, i) => (
           <div key={i} className="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 transition hover:shadow-md">
              <div className="flex justify-between items-baseline mb-2">
                 <h4 className="font-bold text-amber-700 dark:text-amber-400 text-lg">{ex.example_title}</h4>
                 <span className="text-xs font-mono font-bold bg-amber-50 dark:bg-gray-700 text-amber-800 dark:text-amber-300 px-2 py-1 rounded">{ex.reference}</span>
              </div>
              <p className="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">{ex.description}</p>
           </div>
        ))}
      </div>
      
      <div className="bg-indigo-50 dark:bg-indigo-900/20 p-5 rounded-lg border border-indigo-100 dark:border-indigo-800">
         <h3 className="font-bold text-indigo-700 dark:text-indigo-300 mb-2 text-sm uppercase">Practical Application</h3>
         <p className="text-gray-700 dark:text-gray-300 italic">{result.practical_application}</p>
      </div>
    </div>
  );
};

const EpistleSection = ({ result }) => {
  if (!result) return null;
  return (
    <div className="mt-8 space-y-6">
      <div className="bg-rose-50 dark:bg-rose-900/20 p-6 rounded-xl border border-rose-200 dark:border-rose-800">
         <h2 className="text-2xl font-bold text-rose-800 dark:text-rose-300 mb-2">Drafted Message</h2>
         <p className="text-sm text-gray-500 mb-4 uppercase tracking-wider font-bold">Subject: {result.subject_line}</p>
         <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-100 dark:border-gray-700 whitespace-pre-line font-medium text-gray-800 dark:text-gray-200">
            {result.message_body}
         </div>
         <div className="mt-4 p-4 bg-rose-100 dark:bg-rose-800 rounded-lg">
            <p className="text-sm font-bold text-rose-900 dark:text-rose-100">Included Scripture:</p>
            <p className="italic text-rose-800 dark:text-rose-200">{result.scripture_included}</p>
         </div>
         <button onClick={() => navigator.clipboard.writeText(result.message_body)} className="mt-4 text-xs font-bold text-rose-600 hover:text-rose-800 uppercase tracking-widest flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
            Copy to Clipboard
         </button>
      </div>
    </div>
  );
};

const IllustrationSection = ({ result }) => {
  if (!result || !result.illustrations) return null;
  return (
    <div className="mt-8 space-y-6">
      <h2 className="text-2xl font-bold text-center text-teal-800 dark:text-teal-300">Illustrations for "{result.concept}"</h2>
      <div className="grid gap-6">
         {result.illustrations.map((item, index) => (
            <div key={index} className="bg-white dark:bg-gray-800 rounded-xl shadow-md border-l-4 border-teal-500 overflow-hidden">
               <div className="p-5">
                  <div className="flex justify-between items-start mb-2">
                     <h3 className="text-lg font-bold text-gray-900 dark:text-white">{item.title}</h3>
                     <span className="bg-teal-100 text-teal-800 text-xs font-bold px-2 py-1 rounded uppercase">{item.source_type}</span>
                  </div>
                  <p className="text-gray-700 dark:text-gray-300 mb-4 leading-relaxed">{item.content}</p>
                  <div className="bg-gray-50 dark:bg-gray-700 p-3 rounded text-sm italic text-gray-600 dark:text-gray-400 border-t">
                     <span className="font-bold not-italic">Application: </span> {item.application}
                  </div>
               </div>
            </div>
         ))}
      </div>
    </div>
  );
};

const TimelineSection = ({ result }) => {
  if (!result || !result.events) return null;
  const events = Array.isArray(result.events) ? result.events : [];
  
  return (
    <div className="mt-8">
      <h2 className="text-3xl font-extrabold text-center text-slate-800 dark:text-slate-200 mb-8">Timeline: {result.subject}</h2>
      <div className="relative border-l-4 border-slate-300 dark:border-slate-700 ml-4 md:ml-6 space-y-8">
         {events.map((event, index) => (
            <div key={index} className="relative pl-8">
               {/* Dot */}
               <div className="absolute -left-[10px] top-1.5 w-4 h-4 rounded-full bg-slate-500 border-2 border-white dark:border-gray-900"></div>
               
               <div className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700">
                  <span className="text-xs font-bold text-slate-500 uppercase tracking-wide block mb-1">{event.approx_time}</span>
                  <h4 className="text-lg font-bold text-slate-900 dark:text-white mb-1">{event.event_description}</h4>
                  <span className="text-xs font-mono text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-0.5 rounded inline-block">{event.scripture_ref}</span>
               </div>
            </div>
         ))}
      </div>
    </div>
  );
};

// --- NEW COMPONENT: GEM FINDER ---
const GemFinderSection = ({ result }) => {
  if (!result || !result.gems) return null;
  const gems = Array.isArray(result.gems) ? result.gems : [];

  return (
    <div className="mt-8 space-y-8">
       <div className="text-center">
          <h2 className="text-3xl font-serif font-extrabold text-fuchsia-900 dark:text-fuchsia-300 mb-1">Spiritual Gems</h2>
          <p className="text-lg text-gray-600 dark:text-gray-400">
             <span className="font-bold">{result.person}</span> on <span className="font-mono text-fuchsia-600 dark:text-fuchsia-400">{result.reference}</span>
          </p>
       </div>

       <div className="grid gap-6">
          {gems.map((gem, index) => (
             <div key={index} className="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-fuchsia-100 dark:border-gray-700 overflow-hidden relative">
                <div className="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-fuchsia-400 to-purple-600"></div>
                <div className="p-6">
                   <div className="mb-4">
                      <svg className="w-8 h-8 text-fuchsia-200 dark:text-gray-600 mb-2 transform -scale-x-100" fill="currentColor" viewBox="0 0 24 24"><path d="M14.017 21L14.017 18C14.017 16.8954 13.1216 16 12.017 16H9L9.017 21H14.017ZM21.017 21L21.017 18C21.017 16.8954 20.1216 16 19.017 16H16L16.017 21H21.017ZM9.017 13.924C8.6186 13.9723 8.2192 14.017 7.8208 14.017C4.6942 14.017 2.017 11.4502 2.017 8.324C2.017 5.197 4.6942 2.63 7.8208 2.63C8.2192 2.63 8.6186 2.674 9.017 2.724V13.924ZM16.017 13.924C15.6186 13.9723 15.2192 14.017 14.8208 14.017C11.6942 14.017 9.017 11.4502 9.017 8.324C9.017 5.197 11.6942 2.63 14.8208 2.63C15.2192 2.63 15.6186 2.674 16.017 2.724V13.924Z" /></svg>
                      <p className="text-xl font-serif text-gray-800 dark:text-gray-100 italic leading-relaxed">
                        "{gem.quote}"
                      </p>
                   </div>
                   
                   <div className="flex flex-col md:flex-row md:items-center justify-between border-t border-gray-100 dark:border-gray-700 pt-4 mt-4 text-sm">
                      <div className="mb-2 md:mb-0">
                         <span className="font-bold text-fuchsia-800 dark:text-fuchsia-400 uppercase tracking-wider text-xs block mb-1">Source</span>
                         <span className="text-gray-600 dark:text-gray-300 font-medium">{gem.source}</span>
                      </div>
                      <div className="md:text-right">
                         <span className="font-bold text-purple-800 dark:text-purple-400 uppercase tracking-wider text-xs block mb-1">Context</span>
                         <span className="text-gray-500 dark:text-gray-400 italic">{gem.context}</span>
                      </div>
                   </div>
                </div>
             </div>
          ))}
       </div>
    </div>
  );
};

const ChapterSummarySection = ({ result }) => {
  if (!result) return null;
  
  // Safe array access to prevent crashes if API returns null/undefined
  const takeaways = Array.isArray(result.key_takeaways) ? result.key_takeaways : [];
  const applications = Array.isArray(result.life_applications) ? result.life_applications : [];

  return (
    <div className="mt-8 space-y-6">
       <div className="bg-orange-50 dark:bg-orange-900/20 p-6 rounded-xl border border-orange-200 dark:border-orange-700">
          <h2 className="text-2xl font-bold text-orange-900 dark:text-orange-300 text-center mb-4">{result.reference} Summary</h2>
          
          {takeaways.length > 0 && (
          <div className="mb-6">
             <h3 className="font-bold text-orange-800 dark:text-orange-400 uppercase text-sm tracking-wider mb-3">Key Takeaways</h3>
             <ul className="space-y-2">
                {takeaways.map((point, i) => (
                   <li key={i} className="flex items-start">
                      <span className="text-orange-500 mr-2 mt-1">•</span>
                      <span className="text-gray-800 dark:text-gray-200 font-medium">
                        {typeof point === 'string' ? point : JSON.stringify(point)}
                      </span>
                   </li>
                ))}
             </ul>
          </div>
          )}

          {applications.length > 0 && (
          <div>
             <h3 className="font-bold text-orange-800 dark:text-orange-400 uppercase text-sm tracking-wider mb-3">Life Applications</h3>
             <div className="grid gap-3">
                {applications.map((app, i) => (
                   <div key={i} className="bg-white dark:bg-gray-800 p-3 rounded-lg shadow-sm border-l-4 border-orange-400 text-gray-700 dark:text-gray-300 text-sm">
                      {typeof app === 'string' ? app : JSON.stringify(app)}
                   </div>
                ))}
             </div>
          </div>
          )}
       </div>
    </div>
  );
};

// --- NEW COMPONENT: INTERLINEAR BIBLE ---
const InterlinearSection = ({ result }) => {
  const [selectedWord, setSelectedWord] = useState(null);

  if (!result) return null;
  const words = Array.isArray(result.words) ? result.words : [];

  return (
    <div className="mt-8">
      <h2 className="text-3xl font-extrabold text-center mb-2 text-slate-800 dark:text-slate-200">
        Interlinear: {result.reference}
      </h2>
      <p className="text-center text-gray-500 mb-6 uppercase tracking-widest text-xs font-bold">
        {result.original_language} Text Analysis
      </p>

      {/* Word Grid */}
      <div className="flex flex-wrap justify-center gap-4">
        {words.map((word, idx) => (
          <button
            key={idx}
            onClick={() => setSelectedWord(word)}
            className="flex flex-col items-center p-3 rounded-lg hover:bg-slate-100 dark:hover:bg-gray-700 transition border-b-2 border-transparent hover:border-indigo-500 group"
          >
            <span className="text-xl font-serif font-bold text-slate-900 dark:text-slate-100 mb-1 group-hover:text-indigo-600">
              {word.original}
            </span>
            <span className="text-xs text-gray-400 italic mb-1">
              {word.transliteration}
            </span>
             <span className="text-sm font-semibold text-slate-700 dark:text-slate-300 border-b border-indigo-300 dark:border-indigo-700">
              {word.english}
            </span>
          </button>
        ))}
      </div>

      {/* Modal */}
      {selectedWord && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onClick={() => setSelectedWord(null)}>
           <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200" onClick={e => e.stopPropagation()}>
              <div className="bg-slate-900 p-6 text-white text-center relative">
                 <h3 className="text-4xl font-serif font-bold mb-1">{selectedWord.original}</h3>
                 <p className="text-indigo-300 font-mono text-sm">{selectedWord.transliteration}</p>
                 <button onClick={() => setSelectedWord(null)} className="absolute top-4 right-4 text-gray-400 hover:text-white">
                    <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                 </button>
              </div>
              <div className="p-6 space-y-4">
                 <div>
                    <label className="text-xs font-bold uppercase text-gray-400 tracking-wider">English Equivalent</label>
                    <p className="text-2xl font-bold text-slate-800 dark:text-slate-100">{selectedWord.english}</p>
                 </div>
                 <div className="grid grid-cols-2 gap-4">
                    <div className="bg-slate-50 dark:bg-gray-700 p-3 rounded-lg">
                       <label className="text-xs font-bold uppercase text-gray-400 tracking-wider block mb-1">Morphology</label>
                       <p className="text-sm font-mono text-indigo-600 dark:text-indigo-400 font-bold">{selectedWord.morphology}</p>
                    </div>
                     <div className="bg-slate-50 dark:bg-gray-700 p-3 rounded-lg">
                       <label className="text-xs font-bold uppercase text-gray-400 tracking-wider block mb-1">Part of Speech</label>
                       <p className="text-sm font-medium text-gray-700 dark:text-gray-300">{selectedWord.part_of_speech || 'N/A'}</p>
                    </div>
                 </div>
                 
                 <div>
                    <label className="text-xs font-bold uppercase text-gray-400 tracking-wider">Significance & Application</label>
                    <div className="mt-1 p-4 bg-indigo-50 dark:bg-indigo-900/20 border-l-4 border-indigo-500 rounded-r-lg text-sm text-gray-700 dark:text-gray-300 leading-relaxed">
                       {selectedWord.significance}
                    </div>
                 </div>
              </div>
           </div>
        </div>
      )}
    </div>
  );
};

// --- NEW COMPONENT: YOUTH GROUP PLANNER ---
const YouthGroupPlannerSection = ({ result }) => {
  if (!result) return null;
  const lessonOutline = Array.isArray(result.lesson_outline) ? result.lesson_outline : [];
  const discussionQuestions = Array.isArray(result.discussion_questions) ? result.discussion_questions : [];

  return (
    <div className="mt-8 space-y-6">
       <div className="bg-sky-50 dark:bg-sky-900/20 p-6 rounded-xl border border-sky-200 dark:border-sky-700 text-center">
          <h2 className="text-3xl font-extrabold text-sky-800 dark:text-sky-300 mb-2">{result.theme}</h2>
          <p className="text-lg text-gray-700 dark:text-gray-300 italic mb-4">Focus Scripture: {result.scripture_focus}</p>
       </div>

       <div className="grid md:grid-cols-2 gap-6">
          <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border-t-4 border-purple-500">
             <h3 className="font-bold text-gray-500 uppercase text-xs tracking-wider mb-2">Icebreaker Game</h3>
             <h4 className="text-xl font-bold text-purple-700 dark:text-purple-300 mb-2">{result.icebreaker?.name}</h4>
             <p className="text-sm mb-2"><span className="font-bold">Materials:</span> {result.icebreaker?.materials_needed}</p>
             <p className="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">{result.icebreaker?.instructions}</p>
          </div>

          <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border-t-4 border-orange-500">
             <h3 className="font-bold text-gray-500 uppercase text-xs tracking-wider mb-2">Lesson Outline</h3>
             <ul className="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300 text-sm">
                {lessonOutline.map((point, i) => (
                   <li key={i}>{typeof point === 'string' ? point : JSON.stringify(point)}</li>
                ))}
             </ul>
          </div>
       </div>

       <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border-t-4 border-teal-500">
          <h3 className="font-bold text-gray-500 uppercase text-xs tracking-wider mb-4">Discussion Questions</h3>
          <ul className="space-y-3">
             {discussionQuestions.map((q, i) => (
                <li key={i} className="flex items-start">
                   <span className="bg-teal-100 text-teal-800 text-xs font-bold px-2 py-0.5 rounded mr-2 mt-0.5">Q{i+1}</span>
                   <span className="text-gray-800 dark:text-gray-200">{typeof q === 'string' ? q : JSON.stringify(q)}</span>
                </li>
             ))}
          </ul>
       </div>

       <div className="grid md:grid-cols-2 gap-6">
          <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md border-t-4 border-yellow-500">
             <h3 className="font-bold text-gray-500 uppercase text-xs tracking-wider mb-2">Activity / Application</h3>
             <h4 className="text-lg font-bold text-yellow-700 dark:text-yellow-400 mb-1">{result.activity?.name}</h4>
             <p className="text-gray-700 dark:text-gray-300 text-sm">{result.activity?.description}</p>
          </div>
          
          <div className="bg-indigo-50 dark:bg-indigo-900/10 p-6 rounded-xl border border-indigo-100 dark:border-indigo-800">
              <h3 className="font-bold text-indigo-800 dark:text-indigo-400 uppercase text-xs tracking-wider mb-2">Closing Prayer</h3>
              <p className="text-gray-700 dark:text-gray-300 italic text-sm leading-relaxed">{result.closing_prayer}</p>
          </div>
       </div>
    </div>
  );
};

// --- NEW COMPONENT: TYPES OF CHRIST ---
const TypesOfChristSection = ({ result }) => {
  if (!result) return null;
  const typesList = Array.isArray(result.types_list) ? result.types_list : [];

  return (
    <div className="mt-8 space-y-6">
       <div className="bg-amber-50 dark:bg-amber-900/20 p-6 rounded-xl border border-amber-200 dark:border-amber-700 text-center">
          <h2 className="text-3xl font-serif font-extrabold text-amber-900 dark:text-amber-300 mb-2">Shadow & Substance</h2>
          <p className="text-lg text-gray-700 dark:text-gray-300 italic">{result.overview}</p>
       </div>
       <div className="grid gap-6">
          {typesList.map((item, index) => (
             <div key={index} className="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border-t-4 border-amber-500">
                <div className="bg-amber-100 dark:bg-amber-900/40 p-3 text-center border-b border-amber-200 dark:border-amber-800">
                   <h3 className="text-xl font-bold text-amber-900 dark:text-amber-100">{item.type_name}</h3>
                </div>
                <div className="p-5 grid md:grid-cols-2 gap-6 relative">
                   {/* Shadow */}
                   <div className="relative">
                      <h4 className="font-bold text-gray-500 uppercase text-xs tracking-wider mb-2 flex items-center">
                        <span className="mr-1">Old Testament Shadow</span>
                      </h4>
                      <p className="text-gray-800 dark:text-gray-200 text-sm mb-2 leading-relaxed">{item.ot_shadow}</p>
                      <span className="text-xs font-mono font-bold text-amber-700 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/30 px-2 py-1 rounded">{item.ot_reference}</span>
                   </div>
                   
                   {/* Divider for mobile/desktop */}
                   <div className="hidden md:block absolute left-1/2 top-4 bottom-4 w-px bg-gray-200 dark:bg-gray-700"></div>

                   {/* Substance */}
                   <div className="relative md:pl-6 border-t md:border-t-0 pt-4 md:pt-0 border-gray-100 dark:border-gray-700">
                      <h4 className="font-bold text-gray-500 uppercase text-xs tracking-wider mb-2 flex items-center">
                        <span className="mr-1">New Testament Substance</span>
                      </h4>
                      <p className="text-gray-800 dark:text-gray-200 text-sm mb-2 leading-relaxed">{item.nt_fulfillment}</p>
                      <span className="text-xs font-mono font-bold text-amber-700 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/30 px-2 py-1 rounded">{item.nt_reference}</span>
                   </div>
                </div>
                <div className="bg-gray-50 dark:bg-gray-900/50 p-4 text-center text-sm text-gray-600 dark:text-gray-400 italic border-t border-gray-100 dark:border-gray-700">
                   <span className="font-bold not-italic mr-1">Significance:</span> {item.theological_significance}
                </div>
             </div>
          ))}
       </div>
    </div>
  );
};


const BibleViewerModal = ({ viewerState, onClose, loading, fullChapterText }) => {
    if (!viewerState.isOpen) return null;
    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-70" onClick={onClose}>
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl h-5/6 flex flex-col" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b flex justify-between"><h2 className="text-2xl font-bold">{viewerState.title}</h2><button onClick={onClose}>X</button></div>
                <div className="p-6 overflow-y-auto">{loading ? "Loading..." : <p className="whitespace-pre-line text-lg">{fullChapterText}</p>}</div>
            </div>
        </div>
    );
};


// --- MAIN APPLICATION ---

const App = () => {
  const contentRef = useRef(null);
  const audioRef = useRef(new Audio());
    
  const [selectedTranslation, setSelectedTranslation] = useState('ESV');

  // Existing Modes State
  const [situation, setSituation] = useState('');
  const [guidanceResults, setGuidanceResults] = useState(null);
  const [topicQuery, setTopicQuery] = useState('');
  const [topicResults, setTopicResults] = useState(null);
  const [studyVersesInput, setStudyVersesInput] = useState('');
  const [studyPlanResults, setStudyPlanResults] = useState(null);
  const [childrenAgeInput, setChildrenAgeInput] = useState('');
  const [childrenTopicInput, setChildrenTopicInput] = useState('');
  const [childrenStudyResults, setChildrenStudyResults] = useState(null); 
  const [sermonInput, setSermonInput] = useState('');
  const [sermonResults, setSermonResults] = useState(null);
  const [spurgeonInput, setSpurgeonInput] = useState('');
  const [spurgeonResults, setSpurgeonResults] = useState(null);
  const [triviaInput, setTriviaInput] = useState('');
  const [triviaResults, setTriviaResults] = useState(null);
  const [parableInput, setParableInput] = useState('');
  const [parableResult, setParableResult] = useState(null);
  const [apologeticsInput, setApologeticsInput] = useState('');
  const [apologeticsResult, setApologeticsResult] = useState(null);
  const [exegeticalInput, setExegeticalInput] = useState('');
  const [exegeticalResults, setExegeticalResults] = useState(null);
  const [topicalCommentaryInput, setTopicalCommentaryInput] = useState('');
  const [topicalCommentaryResults, setTopicalCommentaryResults] = useState(null);
  const [literalInput, setLiteralInput] = useState('');
  const [literalResults, setLiteralResults] = useState(null);
  const [dictionaryInput, setDictionaryInput] = useState('');
  const [dictionaryResult, setDictionaryResult] = useState(null);
  const [evangelismPersona, setEvangelismPersona] = useState(null);
  const [evangelismChatHistory, setEvangelismChatHistory] = useState([]);
  const [evangelismLoading, setEvangelismLoading] = useState(false);
  const [evangelismHint, setEvangelismHint] = useState(null);
  const [evangelismHintLoading, setEvangelismHintLoading] = useState(false);
  const [customPrayerInputs, setCustomPrayerInputs] = useState(PRAYER_SECTIONS.reduce((acc, section) => ({ ...acc, [section.key]: '' }), {}));
  const [generatedPrayer, setGeneratedPrayer] = useState(null);

  const [hymnInput, setHymnInput] = useState('');
  const [hymnResult, setHymnResult] = useState(null);
  const [symbolismInput, setSymbolismInput] = useState('');
  const [symbolismResult, setSymbolismResult] = useState(null);
  const [selectedCharacter, setSelectedCharacter] = useState(null);
  const [characterChatHistory, setCharacterChatHistory] = useState([]);
  const [characterLoading, setCharacterLoading] = useState(false);
  const [customCharInput, setCustomCharInput] = useState('');

  // New Features State
  const [metaphorInput, setMetaphorInput] = useState('');
  const [metaphorResult, setMetaphorResult] = useState(null);
  const [quietTimeDuration, setQuietTimeDuration] = useState('15');
  const [quietTimeMood, setQuietTimeMood] = useState('');
  const [quietTimeResult, setQuietTimeResult] = useState(null);
  const [debateTopic, setDebateTopic] = useState('');
  const [debateParticipants, setDebateParticipants] = useState('');
  const [debateResult, setDebateResult] = useState(null);
  const [memoryInput, setMemoryInput] = useState('');
  const [memoryResult, setMemoryResult] = useState(null);
  const [nameInput, setNameInput] = useState('');
  const [nameResult, setNameResult] = useState(null);
  const [eventInput, setEventInput] = useState('');
  const [eventTypeInput, setEventTypeInput] = useState('');
  const [eventResult, setEventResult] = useState(null);
  const [remixInput, setRemixInput] = useState('');
  const [remixStyle, setRemixStyle] = useState('Cyberpunk Sci-Fi');
  const [remixResult, setRemixResult] = useState(null);
  const [conflictInput, setConflictInput] = useState('');
  const [conflictResult, setConflictResult] = useState(null);
  const [proverbInput, setProverbInput] = useState('');
  const [proverbResult, setProverbResult] = useState(null);

  // --- NEWEST FEATURES STATE ---
  const [epistleRecipient, setEpistleRecipient] = useState('');
  const [epistleOccasion, setEpistleOccasion] = useState('');
  const [epistleResult, setEpistleResult] = useState(null);

  const [illustrationInput, setIllustrationInput] = useState('');
  const [illustrationResult, setIllustrationResult] = useState(null);

  const [timelineInput, setTimelineInput] = useState('');
  const [timelineResult, setTimelineResult] = useState(null);

  // --- NEW: Summary State ---
  const [summaryInput, setSummaryInput] = useState('');
  const [summaryResult, setSummaryResult] = useState(null);

  // --- NEW: Gem Finder State ---
  const [gemNameInput, setGemNameInput] = useState('');
  const [gemReferenceInput, setGemReferenceInput] = useState('');
  const [gemResult, setGemResult] = useState(null);

  // --- NEW: Interlinear State ---
  const [interlinearInput, setInterlinearInput] = useState('');
  const [interlinearResult, setInterlinearResult] = useState(null);

  // --- NEW: Youth Group Planner State ---
  const [youthInputType, setYouthInputType] = useState('topic'); // 'topic' or 'verse'
  const [youthInput, setYouthInput] = useState('');
  const [youthResult, setYouthResult] = useState(null);

  // --- NEW: Types of Christ State ---
  const [typesInput, setTypesInput] = useState('');
  const [typesResult, setTypesResult] = useState(null);

  // App Status State
  const [activeMode, setActiveMode] = useState('guidance'); 
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [isDarkMode, setIsDarkMode] = useState(false);
  
  // Bible Viewer State
  const [viewerState, setViewerState] = useState({ isOpen: false, reference: '', translation: '' });
  const [fullChapterText, setFullChapterText] = useState('');
  const [viewerLoading, setViewerLoading] = useState(false);

  // Audio & Visual State
  const [isSpeaking, setIsSpeaking] = useState(false);
  const [generatingImage, setGeneratingImage] = useState(false);
  const [generatedImage, setGeneratedImage] = useState(null);

  // Firebase State
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);

  useEffect(() => {
    if (isDarkMode) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
  }, [isDarkMode]);

  useEffect(() => {
    const audio = audioRef.current;
    const handleEnded = () => setIsSpeaking(false);
    audio.addEventListener('ended', handleEnded);
    return () => { audio.removeEventListener('ended', handleEnded); audio.pause(); };
  }, []);

  useEffect(() => {
    if (!firebaseConfig.apiKey) {
      console.warn("Firebase config is missing.");
      setIsAuthReady(true);
      return;
    }
    try {
      const app = initializeApp(firebaseConfig);
      const newAuth = getAuth(app);
      const newDb = getFirestore(app);
      setAuth(newAuth);
      setDb(newDb);
      const unsubscribe = onAuthStateChanged(newAuth, async (user) => {
        if (!user) {
          if (initialAuthToken) await signInWithCustomToken(newAuth, initialAuthToken);
          else await signInAnonymously(newAuth);
        }
        setUserId(newAuth.currentUser?.uid || crypto.randomUUID());
        setIsAuthReady(true);
      });
      return () => unsubscribe();
    } catch (e) { console.error("Firebase Error:", e); setIsAuthReady(true); }
  }, []);

  // API Call Wrapper
  const callGeminiApi = useCallback(async (userQuery, systemPrompt, responseSchema = null, history = []) => {
    // REMOVED local apiKey definition to use the global one
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    let contents = [];
    if (history.length > 0) {
        contents = history.map(msg => ({ role: msg.role === 'user' ? 'user' : 'model', parts: [{ text: msg.text }] }));
        contents.push({ role: 'user', parts: [{ text: userQuery }] });
    } else {
        contents = [{ parts: [{ text: userQuery }] }];
    }

    const payload = {
      contents: contents,
      systemInstruction: { parts: [{ text: systemPrompt }] },
      safetySettings: [
        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
      ]
    };
    
    if (responseSchema) {
        payload.generationConfig = { responseMimeType: "application/json", responseSchema: responseSchema };
    }

    try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`API returned status ${response.status}`);
        const result = await response.json();
        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (jsonText) {
          if (responseSchema) return JSON.parse(jsonText);
          return jsonText;
        } 
        throw new Error("Received empty response.");
    } catch (e) {
        console.error("API Error:", e);
        throw e;
    }
  }, []);
  
  // TTS Handler
  const handleSpeak = async (text) => {
    if (isSpeaking) { audioRef.current.pause(); setIsSpeaking(false); return; }
    setIsSpeaking(true);
    // REMOVED local apiKey definition to use the global one
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
    const cleanText = text.replace(/[*_#]/g, '');
    const payload = {
        contents: [{ parts: [{ text: cleanText }] }],
        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } }
    };
    try {
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) throw new Error("TTS failed");
        const result = await response.json();
        const base64Audio = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
        const wavUrl = pcmToWav(base64Audio, 24000);
        if (wavUrl) { audioRef.current.src = wavUrl; audioRef.current.play(); }
    } catch (e) { console.error("TTS Error:", e); setIsSpeaking(false); }
  };

  // Image Gen Handler
  const handleGenerateImage = async (prompt) => {
      setGeneratingImage(true);
      setError(null);
      // REMOVED local apiKey definition to use the global one
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
      const payload = { instances: [{ prompt: prompt }], parameters: { sampleCount: 1 } };
      try {
          const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          if (!response.ok) throw new Error("Image gen failed");
          const result = await response.json();
          const base64Image = result.predictions?.[0]?.bytesBase64Encoded;
          if (base64Image) setGeneratedImage(`data:image/png;base64,${base64Image}`);
      } catch (e) { console.error("Image Error:", e); } finally { setGeneratingImage(false); }
  };

  // Chapter Context Handler
  const fetchFullChapterText = useCallback(async (reference, translation) => {
    setViewerLoading(true);
    setFullChapterText(''); 
    try {
        const systemPrompt = `Retrieve the full chapter context for: ${reference} in ${translation}. Return plain text.`;
        const userQuery = `Retrieve the full chapter context for the reference: ${reference}.`;
        const response = await callGeminiApi(userQuery, systemPrompt, null);
        setFullChapterText(response);
    } catch (e) { setFullChapterText("Error retrieving text."); } finally { setViewerLoading(false); }
  }, [callGeminiApi]);
  
  const handleVerseClick = (reference, translation) => {
    setFullChapterText('');
    setViewerLoading(true);
    setViewerState({ isOpen: true, title: `${reference} Context (${translation})`, reference, translation });
    fetchFullChapterText(reference, translation);
  };
  
  const handleModalClose = () => { setViewerState({ isOpen: false, reference: '', translation: '' }); setFullChapterText(''); };

  // --- Handlers for Existing Features (Simplified for brevity as logic is same) ---
  const handleGuidanceSubmit = async (e) => { e.preventDefault(); if (!situation.trim()) return; setLoading(true); try { const r = await callGeminiApi(`Situation: "${situation}"`, `Provide 3-5 scriptures and a prayer in ${selectedTranslation}.`, RESPONSE_SCHEMA_SCRIPTURE); setGuidanceResults(r); } catch (e) { setError(e.message); } finally { setLoading(false); } };
  const handleTopicSubmit = async (e) => { e.preventDefault(); if (!topicQuery.trim()) return; setLoading(true); try { const r = await callGeminiApi(`Topic: "${topicQuery}"`, `Provide 3-7 scriptures in ${selectedTranslation}.`, RESPONSE_SCHEMA_SCRIPTURE); setTopicResults(r); } catch (e) { setError(e.message); } finally { setLoading(false); } };
  const handleStudySubmit = async (e) => { e.preventDefault(); if (!studyVersesInput.trim()) return; setLoading(true); try { const r = await callGeminiApi(`Verses: "${studyVersesInput}"`, `Create study plan in ${selectedTranslation}.`, RESPONSE_SCHEMA_STUDY); setStudyPlanResults(r); } catch (e) { setError(e.message); } finally { setLoading(false); } };
  const handleCustomPrayerSubmit = async (e) => { e.preventDefault(); setLoading(true); try { const r = await callGeminiApi(`Combine inputs into prayer: ${JSON.stringify(customPrayerInputs)}`, "Weave into one prayer.", null); setGeneratedPrayer(r); } catch (e) { setError(e.message); } finally { setLoading(false); } };
  const handleChildrenStudySubmit = async (e) => { e.preventDefault(); setLoading(true); try { const r = await callGeminiApi(`Lesson on "${childrenTopicInput}" for age ${childrenAgeInput}`, "Create child lesson plan.", null); setChildrenStudyResults(r); } catch (e) { setError(e.message); } finally { setLoading(false); } };
  const handleSermonSubmit = async (e) => { e.preventDefault(); if (!sermonInput.trim()) return; setLoading(true); setGeneratedImage(null); try { const r = await callGeminiApi(`Outline for: "${sermonInput}"`, `Create sermon outline in ${selectedTranslation}.`, RESPONSE_SCHEMA_SERMON); setSermonResults(r); } catch (e) { setError(e.message); } finally { setLoading(false); } };
  const handleSpurgeonSubmit = async (e) => { e.preventDefault(); if (!spurgeonInput.trim()) return; setLoading(true); setGeneratedImage(null); try { const r = await callGeminiApi(`Topic: "${spurgeonInput}"`, "Create Spurgeon style sermon.", RESPONSE_SCHEMA_SERMON); setSpurgeonResults(r); } catch (e) { setError(e.message); } finally { setLoading(false); } };
  const handleTriviaSubmit = async (e) => { if(e) e.preventDefault(); setLoading(true); try { const r = await callGeminiApi(triviaInput ? `Topic: "${triviaInput}"` : "Random question", "Generate Bible trivia.", RESPONSE_SCHEMA_TRIVIA); setTriviaResults(r); } catch (e) { setError(e.message); } finally { setLoading(false); } };
  const handleParableSubmit = async (e) => { e.preventDefault(); if (!parableInput.trim()) return; setLoading(true); try { const r = await callGeminiApi(`Situation: "${parableInput}"`, "Write a modern parable.", null); setParableResult(r); } catch (e) { setError(e.message); } finally { setLoading(false); } };
  const handleApologeticsSubmit = async (e) => { e.preventDefault(); if (!apologeticsInput.trim()) return; setLoading(true); try { const r = await callGeminiApi(`Question: "${apologeticsInput}"`, "Provide theologian answer.", RESPONSE_SCHEMA_APOLOGETICS); setApologeticsResult(r); } catch (e) { setError(e.message); } finally { setLoading(false); } };
  const handleExegeticalSubmit = async (e) => { e.preventDefault(); if (!exegeticalInput.trim()) return; setLoading(true); try { const r = await callGeminiApi(`Passage: "${exegeticalInput}"`, "Provide exegetical analysis.", RESPONSE_SCHEMA_EXEGETICAL); setExegeticalResults(r); } catch (e) { setError(e.message); } finally { setLoading(false); } };
  const handleTopicalCommentarySubmit = async (e) => { e.preventDefault(); if (!topicalCommentaryInput.trim()) return; setLoading(true); try { const r = await callGeminiApi(`Topic: "${topicalCommentaryInput}"`, "Provide theological commentary.", RESPONSE_SCHEMA_TOPICAL_COMMENTARY); setTopicalCommentaryResults(r); } catch (e) { setError(e.message); } finally { setLoading(false); } };
  
  // FIX: Updated handleLiteralSubmit with robust system prompt
  const handleLiteralSubmit = async (e) => {
      e.preventDefault();
      if (!literalInput.trim()) return;
      setLoading(true);
      try {
        const systemPrompt = "You are a biblical language expert. The user will provide a verse reference or text. 1. Identify the original Hebrew or Greek text. 2. Break it down into word-for-word segments. 3. For each segment, provide the English literal meaning, morphological parsing, and brief significance.";
        const userQuery = `Analyze the original text for: "${literalInput}"`;
        const r = await callGeminiApi(userQuery, systemPrompt, RESPONSE_SCHEMA_LITERAL);
        setLiteralResults(r);
      } catch (e) {
        setError(e.message);
      } finally {
        setLoading(false);
      }
    };

  const handleDictionarySubmit = async (e) => { e.preventDefault(); if (!dictionaryInput.trim()) return; setLoading(true); setGeneratedImage(null); try { const r = await callGeminiApi(`Define: "${dictionaryInput}"`, "Provide bible dictionary entry.", RESPONSE_SCHEMA_DICTIONARY); setDictionaryResult(r); } catch (e) { setError(e.message); } finally { setLoading(false); } };
  const handleHymnSubmit = async (e) => { e.preventDefault(); if (!hymnInput.trim()) return; setLoading(true); try { const r = await callGeminiApi(`Hymn about "${hymnInput}"`, "Create hymn.", RESPONSE_SCHEMA_HYMN); setHymnResult(r); } catch (e) { setError(e.message); } finally { setLoading(false); } };
  const handleSymbolismSubmit = async (e) => { e.preventDefault(); if (!symbolismInput.trim()) return; setLoading(true); try { const r = await callGeminiApi(`Symbolism of "${symbolismInput}"`, "Analyze symbolism.", null); setSymbolismResult(r); } catch (e) { setError(e.message); } finally { setLoading(false); } };

  // Evangelism Handlers
  const startEvangelismChat = async (personaId) => { const p = EVANGELISM_PERSONAS.find(x => x.id === personaId); setEvangelismPersona(p); setEvangelismChatHistory([]); setEvangelismLoading(true); try { const r = await callGeminiApi("Start conversation.", `${p.prompt} Engage briefly.`, null, []); setEvangelismChatHistory([{ role: 'model', text: r }]); } catch (e) { setError(e.message); } finally { setEvangelismLoading(false); } };
  const handleEvangelismSend = async (msg) => { const newHist = [...evangelismChatHistory, { role: 'user', text: msg }]; setEvangelismChatHistory(newHist); setEvangelismLoading(true); setEvangelismHint(null); try { const r = await callGeminiApi(msg, `${evangelismPersona.prompt} Reply briefly.`, null, newHist); setEvangelismChatHistory(prev => [...prev, { role: 'model', text: r }]); } catch (e) { setError(e.message); } finally { setEvangelismLoading(false); } };
  const handleEvangelismHint = async () => { setEvangelismHintLoading(true); try { const r = await callGeminiApi("Give hint.", "Provide coaching hint.", null, evangelismChatHistory); setEvangelismHint(r); } catch(e) { setError(e.message); } finally { setEvangelismHintLoading(false); } };

  // Character Chat Handlers
  const startCharacterChat = async (characterObj) => { 
      setSelectedCharacter(characterObj); 
      setCharacterChatHistory([]); 
      setCharacterLoading(true); 
      try { 
          const r = await callGeminiApi("Greeting.", `${characterObj.prompt} Be concise.`, null, []); 
          setCharacterChatHistory([{ role: 'model', text: r }]); 
      } catch (e) { 
          setError(e.message); 
      } finally { 
          setCharacterLoading(false); 
      } 
  };
  const handleCharacterSend = async (msg) => { const newHist = [...characterChatHistory, { role: 'user', text: msg }]; setCharacterChatHistory(newHist); setCharacterLoading(true); try { const r = await callGeminiApi(msg, `${selectedCharacter.prompt} Be concise.`, null, newHist); setCharacterChatHistory(prev => [...prev, { role: 'model', text: r }]); } catch (e) { setError(e.message); } finally { setCharacterLoading(false); } };

  // Metaphor Master
  const handleMetaphorSubmit = async (e) => {
    e.preventDefault();
    if (!metaphorInput.trim()) return;
    setLoading(true);
    setMetaphorResult(null);
    try {
        const systemPrompt = `You are a master communicator. Create 3 distinct analogies to explain the user's theological concept.`;
        const userQuery = `Create metaphors for: "${metaphorInput.trim()}"`;
        const response = await callGeminiApi(userQuery, systemPrompt, RESPONSE_SCHEMA_METAPHOR);
        setMetaphorResult(response);
    } catch (e) { setError(e.message); } finally { setLoading(false); }
  };

  // Quiet Time Architect
  const handleQuietTimeSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setQuietTimeResult(null);
    try {
        const systemPrompt = `Create a devotional routine for ${quietTimeDuration} minutes. Mood: ${quietTimeMood}. Steps should have duration, activity name, and content (prayer prompt or scripture).`;
        const userQuery = `Generate a ${quietTimeDuration}-minute quiet time plan. I am feeling: ${quietTimeMood}.`;
        const response = await callGeminiApi(userQuery, systemPrompt, RESPONSE_SCHEMA_QUIET_TIME);
        setQuietTimeResult(response);
    } catch (e) { setError(e.message); } finally { setLoading(false); }
  };

  // Biblical Debate
  const handleDebateSubmit = async (e) => {
    e.preventDefault();
    if (!debateTopic.trim() || !debateParticipants.trim()) return;
    setLoading(true);
    setDebateResult(null);
    try {
        const systemPrompt = `Simulate a theological dialogue between the two requested figures. They should discuss the topic respectfully but firmly from their biblical viewpoints. Provide a conclusion summary. Additionally, provide a 'historical_verdict' paragraph that objectively analyzes which view (or balance of views) has coincided best with orthodox church history from the Early Church fathers through the Reformation to the present day.`;
        const userQuery = `Simulate a debate on "${debateTopic}" between: ${debateParticipants}.`;
        const response = await callGeminiApi(userQuery, systemPrompt, RESPONSE_SCHEMA_DEBATE);
        setDebateResult(response);
    } catch (e) { setError(e.message); } finally { setLoading(false); }
  };

  // Memorization Coach
  const handleMemorySubmit = async (e) => {
    e.preventDefault();
    if (!memoryInput.trim()) return;
    setLoading(true);
    setMemoryResult(null);
    try {
      const systemPrompt = `You are a memorization coach. For the requested verse (in ${selectedTranslation}), provide the full text, a creative mnemonic device (acronym or rhyme), a visual imagery prompt to help recall it, and a fill-in-the-blank version of the verse (replace key words with underscores).`;
      const userQuery = `Help me memorize: ${memoryInput} in ${selectedTranslation}.`;
      const response = await callGeminiApi(userQuery, systemPrompt, RESPONSE_SCHEMA_MEMORIZATION);
      setMemoryResult(response);
    } catch (e) { setError(e.message); } finally { setLoading(false); }
  };

  // Name Assistant
  const handleNameSubmit = async (e) => {
    e.preventDefault();
    if (!nameInput.trim()) return;
    setLoading(true);
    setNameResult(null);
    try {
      const systemPrompt = `You are a biblical onomastic expert. Suggest 3-5 biblical names that match the user's desired meaning or theme. For each, give the original Hebrew/Greek word and the biblical context/character.`;
      const userQuery = `Find biblical names meaning or related to: "${nameInput}".`;
      const response = await callGeminiApi(userQuery, systemPrompt, RESPONSE_SCHEMA_NAMES);
      setNameResult(response);
    } catch (e) { setError(e.message); } finally { setLoading(false); }
  };

  // Event Planner
  const handleEventSubmit = async (e) => {
    e.preventDefault();
    if (!eventInput.trim() || !eventTypeInput.trim()) return;
    setLoading(true);
    setEventResult(null);
    try {
      const systemPrompt = `You are a creative church event coordinator. Plan an event based on the user's input. Provide a catchy theme title, a central scripture focus, an icebreaker game idea, decor suggestions, and a simple 4-5 item schedule.`;
      const userQuery = `Plan a "${eventTypeInput}" about: "${eventInput}".`;
      const response = await callGeminiApi(userQuery, systemPrompt, RESPONSE_SCHEMA_EVENT);
      setEventResult(response);
    } catch (e) { setError(e.message); } finally { setLoading(false); }
  };

  // ✨ Bible Story Remix
  const handleRemixSubmit = async (e) => {
    e.preventDefault();
    if (!remixInput.trim()) return;
    setLoading(true);
    setRemixResult(null);
    try {
      const systemPrompt = `You are a creative storyteller. Retell the biblical story requested in the specified style/genre. Keep it faithful to the plot but change the tone, setting, and dialogue style to match the genre perfectly.`;
      const userQuery = `Retell the story of: "${remixInput}" in the style of: "${remixStyle}".`;
      const response = await callGeminiApi(userQuery, systemPrompt, RESPONSE_SCHEMA_REMIX);
      setRemixResult(response);
    } catch (e) { setError(e.message); } finally { setLoading(false); }
  };

  // ✨ Conflict Resolver
  const handleConflictSubmit = async (e) => {
    e.preventDefault();
    if (!conflictInput.trim()) return;
    setLoading(true);
    setConflictResult(null);
    try {
      const systemPrompt = `You are a biblical peacemaker and mediator. Analyze the user's conflict description. Provide a biblical analysis, 3 relevant biblical principles with verses, a step-by-step action plan for reconciliation, a sample conversation script to start the dialogue, and a prayer for peace.`;
      const userQuery = `Help me resolve this conflict: "${conflictInput}".`;
      const response = await callGeminiApi(userQuery, systemPrompt, RESPONSE_SCHEMA_CONFLICT);
      setConflictResult(response);
    } catch (e) { setError(e.message); } finally { setLoading(false); }
  };

  // ✨ Proverb Interpreter
  const handleProverbSubmit = async (e) => {
    e.preventDefault();
    if (!proverbInput.trim()) return;
    setLoading(true);
    setProverbResult(null);
    try {
        const systemPrompt = `You are a biblical wisdom teacher. Interpret the requested Proverb (verse reference or text). Provide its full text in the ${selectedTranslation} translation, a clear meaning, 2-3 specific biblical examples (stories/characters) where this principle is seen in action, and a practical application.`;
        const userQuery = `Interpret this proverb: "${proverbInput}".`;
        const response = await callGeminiApi(userQuery, systemPrompt, RESPONSE_SCHEMA_PROVERB);
        setProverbResult(response);
    } catch (e) { setError(e.message); } finally { setLoading(false); }
  };

  // ✨ NEW: Epistle Writer
  const handleEpistleSubmit = async (e) => {
      e.preventDefault();
      if (!epistleRecipient.trim() || !epistleOccasion.trim()) return;
      setLoading(true);
      setEpistleResult(null);
      try {
          const systemPrompt = `You are a wise and compassionate biblical friend. Write a personal note/message to the recipient based on the occasion. It should be encouraging, warm, and include one perfect scripture reference woven into the text.`;
          const userQuery = `Write a message to "${epistleRecipient}" about "${epistleOccasion}".`;
          const response = await callGeminiApi(userQuery, systemPrompt, RESPONSE_SCHEMA_EPISTLE);
          setEpistleResult(response);
      } catch (e) { setError(e.message); } finally { setLoading(false); }
  };

  // ✨ NEW: Sermon Illustrator
  const handleIllustrationSubmit = async (e) => {
      e.preventDefault();
      if (!illustrationInput.trim()) return;
      setLoading(true);
      setIllustrationResult(null);
      try {
          const systemPrompt = `You are a sermon researcher. Find 3 DISTINCT real-world illustrations (Historical event, Scientific fact, or Biographical story) that perfectly illustrate the user's theological concept. Do NOT invent fictional stories.`;
          const userQuery = `Find illustrations for: "${illustrationInput}".`;
          const response = await callGeminiApi(userQuery, systemPrompt, RESPONSE_SCHEMA_ILLUSTRATION);
          setIllustrationResult(response);
      } catch (e) { setError(e.message); } finally { setLoading(false); }
  };

  // ✨ NEW: Biblical Timeline
  const handleTimelineSubmit = async (e) => {
      e.preventDefault();
      if (!timelineInput.trim()) return;
      setLoading(true);
      setTimelineResult(null);
      try {
          const systemPrompt = `Create a chronological timeline for the requested biblical character or era. Include approximate dates/times, a brief description of the event, and the scripture reference.`;
          const userQuery = `Create a timeline for: "${timelineInput}".`;
          const response = await callGeminiApi(userQuery, systemPrompt, RESPONSE_SCHEMA_TIMELINE);
          setTimelineResult(response);
      } catch (e) { setError(e.message); } finally { setLoading(false); }
  };
  
  // ✨ NEW: Chapter Summarizer
  const handleSummarySubmit = async (e) => {
      e.preventDefault();
      if (!summaryInput.trim()) return;
      setLoading(true);
      setSummaryResult(null);
      try {
          const systemPrompt = `You are a biblical scholar. Summarize the requested chapter/passage. Provide 3-5 concise bullet points for key takeaways and 3 specific, practical life applications for a modern believer.`;
          const userQuery = `Summarize: "${summaryInput}" in ${selectedTranslation}.`;
          const response = await callGeminiApi(userQuery, systemPrompt, RESPONSE_SCHEMA_SUMMARY);
          setSummaryResult(response);
      } catch (e) { setError(e.message); } finally { setLoading(false); }
  };


  const handlePrayerInputChange = (key, value) => { setCustomPrayerInputs(prev => ({ ...prev, [key]: value })); setGeneratedPrayer(null); };
  const scrollToContent = () => { if (contentRef.current) contentRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' }); };
  const switchMode = (mode) => { 
      setActiveMode(mode); setError(null); setGeneratedImage(null); setEvangelismPersona(null); setSelectedCharacter(null); 
      setHymnResult(null); setSymbolismResult(null); setMetaphorResult(null); setQuietTimeResult(null); setDebateResult(null);
      setMemoryResult(null); setNameResult(null); setEventResult(null); setRemixResult(null); setConflictResult(null); setProverbResult(null);
      setEpistleResult(null); setIllustrationResult(null); setTimelineResult(null); setSummaryResult(null); setGemResult(null);
      setInterlinearResult(null); setYouthResult(null); setTypesResult(null);
      setTimeout(scrollToContent, 100); 
  };

  // ... existing API calls ...

  // ✨ NEW: Gem Finder Handler
  const handleGemFinderSubmit = async (e) => {
      e.preventDefault();
      if (!gemNameInput.trim() || !gemReferenceInput.trim()) return;
      setLoading(true);
      setGemResult(null);
      try {
          const systemPrompt = `You are a theological historian and researcher. Your goal is to find REAL, authentic quotes or writings by the requested person regarding the requested scripture (chapter or verses). 
          
          If the person explicitly wrote commentary on this text, provide those quotes and cite the source (Book, Sermon title, Letter).
          
          If they did not write about this specific verse, provide their most relevant authentic quotes regarding the THEMES of that passage.
          
          Strictly avoid inventing quotes. If no direct quote exists, state clearly in the 'context' field that this is a quote on the theme, not the verse itself.`;
          
          const userQuery = `Find spiritual gems by "${gemNameInput}" on "${gemReferenceInput}".`;
          const response = await callGeminiApi(userQuery, systemPrompt, RESPONSE_SCHEMA_GEM);
          setGemResult(response);
      } catch (e) { setError(e.message); } finally { setLoading(false); }
  };

  // ✨ NEW: Interlinear Handler
  const handleInterlinearSubmit = async (e) => {
    e.preventDefault();
    if (!interlinearInput.trim()) return;
    setLoading(true);
    setInterlinearResult(null);
    try {
        const systemPrompt = `You are a biblical languages scholar. Create an Interlinear breakdown for the requested verse(s). Identify the language (Hebrew/Greek). For EVERY word in the original text, provide:
        1. The original word.
        2. Transliteration.
        3. English literal translation.
        4. Part of speech (Noun, Verb, etc.).
        5. Morphology (e.g., Aorist Active Indicative).
        6. Brief definition.
        7. Significance: Explain the tense/mood/voice or word choice theological impact (the 'fun stuff' - e.g., 'The continuous aspect implies...').`;

        const userQuery = `Create an interlinear analysis for: "${interlinearInput}".`;
        const response = await callGeminiApi(userQuery, systemPrompt, RESPONSE_SCHEMA_INTERLINEAR);
        setInterlinearResult(response);
    } catch (e) { setError(e.message); } finally { setLoading(false); }
  };

  // ✨ NEW: Youth Group Planner Handler
  const handleYouthGroupSubmit = async (e) => {
      e.preventDefault();
      if (!youthInput.trim()) return;
      setLoading(true);
      setYouthResult(null);
      try {
          const systemPrompt = `You are a fun and engaging youth pastor. Create a youth group meeting plan (approx 60-90 mins). 
          The plan should include:
          1. A catchy Theme Title.
          2. A Scripture Focus (if one isn't provided, suggest a perfect one).
          3. A Fun Icebreaker Game (Name, materials needed, and brief instructions).
          4. A Short Lesson Outline (3-5 bullet points that are relevant to teenagers).
          5. 3-4 Engaging Discussion Questions.
          6. An Activity or Application Challenge to do during or after the lesson.
          7. A short closing prayer.`;

          const userQuery = `Create a youth group plan based on the ${youthInputType}: "${youthInput}".`;
          const response = await callGeminiApi(userQuery, systemPrompt, RESPONSE_SCHEMA_YOUTH_PLAN);
          setYouthResult(response);
      } catch (e) { setError(e.message); } finally { setLoading(false); }
  };

  // ✨ NEW: Types of Christ Handler
  const handleTypesSubmit = async (e) => {
      e.preventDefault();
      setLoading(true);
      setTypesResult(null);
      try {
          const systemPrompt = `You are a master biblical theologian specializing in Typology. Identify Types of Christ (Shadows) in the Old Testament and explain their fulfillment (Substance) in Christ. 
          Provide the name, a description of the shadow, the specific OT reference, the description of the fulfillment, the specific NT reference, and a brief theological summary of the connection.
          If the user provides a specific topic (e.g., 'Joseph', 'The Tabernacle'), focus on that. If the input is empty or generic, provide 5-10 distinct, major examples (e.g., Adam, Melchizedek, Passover Lamb, Brazen Serpent, Jonah).`;
          
          const userQuery = typesInput.trim() 
            ? `Find Types of Christ related to: "${typesInput}".` 
            : `List major Types of Christ in the Old Testament.`;
            
          const response = await callGeminiApi(userQuery, systemPrompt, RESPONSE_SCHEMA_TYPES_OF_CHRIST);
          setTypesResult(response);
      } catch (e) { setError(e.message); } finally { setLoading(false); }
  };

  // ... existing handlers ...

  const modeButtons = [
    { mode: 'guidance', label: 'Daily Guidance', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.042m0 0V11a11.956 11.956 0 018.618-3.042m0 0V21" /></svg>, colors: 'bg-indigo-500 hover:bg-indigo-600 text-white' },
    { mode: 'interlinear', label: 'Interlinear Bible', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.247m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.247"/><path strokeLinecap="round" strokeLinejoin="round" d="M9 21h6m-6 0v-2m6 2v-2m-6 0h6"/></svg>, colors: 'bg-stone-600 hover:bg-stone-700 text-white' },
    { mode: 'types_of_christ', label: 'Types of Christ', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>, colors: 'bg-amber-500 hover:bg-amber-600 text-white' },
    { mode: 'gem_finder', label: 'Gem Finder', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>, colors: 'bg-fuchsia-600 hover:bg-fuchsia-700 text-white' },
    { mode: 'summary', label: 'Chapter Summary ✨', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.247m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.247" /></svg>, colors: 'bg-orange-700 hover:bg-orange-800 text-white' },
    { mode: 'epistle', label: 'Epistle Writer', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>, colors: 'bg-rose-600 hover:bg-rose-700 text-white' },
    { mode: 'illustration', label: 'Illustrator', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>, colors: 'bg-teal-600 hover:bg-teal-700 text-white' },
    { mode: 'timeline', label: 'Bible Timeline', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>, colors: 'bg-slate-600 hover:bg-slate-700 text-white' },
    { mode: 'remix', label: 'Story Remix', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>, colors: 'bg-purple-800 hover:bg-purple-900 text-white' },
    { mode: 'conflict', label: 'Peace Maker', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01m-4.5 5.5h.01m-4.5 5.5h.01M12 21.75c-4.97 0-9-4.03-9-9s4.03-9 9-9 9 4.03 9 9-4.03 9-9 9z" /></svg>, colors: 'bg-blue-600 hover:bg-blue-700 text-white' },
    { mode: 'proverb', label: 'Proverb Guide', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" /></svg>, colors: 'bg-yellow-600 hover:bg-yellow-700 text-white' },
    { mode: 'metaphor', label: 'Metaphor Master', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>, colors: 'bg-violet-600 hover:bg-violet-700 text-white' },
    { mode: 'memorization', label: 'Memory Coach', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>, colors: 'bg-lime-600 hover:bg-lime-700 text-white' },
    { mode: 'name_gen', label: 'Name Assistant', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>, colors: 'bg-fuchsia-700 hover:bg-fuchsia-800 text-white' },
    { mode: 'event_planner', label: 'Event Planner', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>, colors: 'bg-cyan-700 hover:bg-cyan-800 text-white' },
    { mode: 'quiet_time', label: 'Quiet Time', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>, colors: 'bg-emerald-600 hover:bg-emerald-700 text-white' },
    { mode: 'youth_planner', label: 'Youth Group', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>, colors: 'bg-sky-500 hover:bg-sky-600 text-white' },
    { mode: 'debate', label: 'Debate Sim', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" /></svg>, colors: 'bg-gray-800 hover:bg-black text-white' },
    { mode: 'character_chat', label: 'Character Chat', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>, colors: 'bg-amber-700 hover:bg-amber-800 text-white' },
    { mode: 'hymn', label: 'Hymn Writer', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" /></svg>, colors: 'bg-rose-500 hover:bg-rose-600 text-white' },
    { mode: 'symbolism', label: 'Symbolism', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>, colors: 'bg-indigo-900 hover:bg-black text-white' },
    { mode: 'topic', label: 'Scripture\nSearch', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>, colors: 'bg-teal-500 hover:bg-teal-600 text-white' },
    { mode: 'exegetical', label: 'Exegetical Commentary', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.247m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.247"/><path strokeLinecap="round" strokeLinejoin="round" d="M9 21h6m-6 0v-2m6 2v-2m-6 0h6"/></svg>, colors: 'bg-teal-800 hover:bg-teal-900 text-white' },
    { mode: 'literal', label: 'Literal Translation', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>, colors: 'bg-slate-500 hover:bg-slate-600 text-white' },
    { mode: 'topical_commentary', label: 'Topical Commentary', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>, colors: 'bg-sky-600 hover:bg-sky-700 text-white' },
    { mode: 'dictionary', label: 'Dictionary', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.247m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.247"/><path strokeLinecap="round" strokeLinejoin="round" d="M9 21h6m-6 0v-2m6 2v-2m-6 0h6"/></svg>, colors: 'bg-fuchsia-600 hover:bg-fuchsia-700 text-white' },
    { mode: 'evangelism', label: 'Evangelism Sim', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" /></svg>, colors: 'bg-red-600 hover:bg-red-700 text-white' },
    { mode: 'parable', label: 'Modern Parable', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.247m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.247"/></svg>, colors: 'bg-amber-600 hover:bg-amber-700 text-white' },
    { mode: 'apologetics', label: 'Theologian', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>, colors: 'bg-blue-800 hover:bg-blue-900 text-white' },
    { mode: 'study', label: 'Adult Study Plan', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.247m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.247"/></svg>, colors: 'bg-orange-500 hover:bg-orange-600 text-white' },
    { mode: 'sermon_outline', label: 'Sermon Outline', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" /></svg>, colors: 'bg-purple-600 hover:bg-purple-700 text-white' },
    { mode: 'spurgeon', label: 'Spurgeon', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.247m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.247"/></svg>, colors: 'bg-gray-700 hover:bg-gray-800 text-white' },
    { mode: 'trivia', label: 'Bible Trivia', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>, colors: 'bg-cyan-600 hover:bg-cyan-700 text-white' },
    { mode: 'children_study', label: "Child's Lesson", icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>, colors: 'bg-green-500 hover:bg-green-600 text-white' },
    { mode: 'custom_prayer', label: 'Prayer Builder', icon: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01m-4.5 5.5h.01m-4.5 5.5h.01M12 21.75c-4.97 0-9-4.03-9-9s4.03-9 9-9 9 4.03 9 9-4.03 9-9 9z" /></svg>, colors: 'bg-pink-500 hover:bg-pink-600 text-white' },
  ];

  // FIX: Sorted ALL modes alphabetically for main display
  const allModes = modeButtons.sort((a, b) => a.label.localeCompare(b.label));

  return (
    <div className="min-h-screen bg-gray-900 font-['Inter'] transition-colors duration-300 pb-32 bg-[url('https://images.unsplash.com/photo-1462331940025-496dfbfc7564?q=80&w=2011&auto=format&fit=crop')] bg-cover bg-fixed bg-center">
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap');
        .font-calligraphy {
          font-family: 'Great Vibes', cursive;
        }
      `}</style>
      <button onClick={() => setIsDarkMode(!isDarkMode)} className="fixed top-2 right-2 z-50 p-3 rounded-full text-white bg-gray-700 dark:bg-gray-200 dark:text-gray-800 shadow-xl">{isDarkMode ? "☀" : "☾"}</button>
      <div className="max-w-5xl mx-auto pt-12"> 
        <header className="text-center py-6 relative z-10 flex flex-col items-center">
            <h1 className="text-6xl font-calligraphy text-yellow-400 drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)] py-2">
              Study Buddy
            </h1>
            
            <p className="text-lg font-serif text-yellow-300 mt-4 italic max-w-2xl mx-auto px-4 drop-shadow-md border-t border-white/20 pt-4">
              "Do your best to present yourself to God as one approved, a worker who has no need to be ashamed, rightly handling the word of truth." 
              <span className="block font-semibold not-italic mt-1 text-yellow-300">– 2 Timothy 2:15</span>
            </p>
            {userId && <p className="text-xs text-gray-400 mt-1 drop-shadow-sm">User ID: {userId}</p>}
        </header>

        <div className="flex justify-center items-center max-w-sm mx-auto mb-6 p-3 bg-indigo-50/90 dark:bg-gray-700/90 backdrop-blur-sm rounded-xl shadow-md border border-white/20">
            <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mr-3">Preferred Translation:</label>
            <select value={selectedTranslation} onChange={(e) => setSelectedTranslation(e.target.value)} className="py-2 px-3 border rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white">
                {AVAILABLE_TRANSLATIONS.map(t => (<option key={t} value={t}>{t}</option>))}
            </select>
        </div>

        {/* --- MAIN FEATURE GRID (Top) --- */}
        <div className="max-w-6xl mx-auto px-4">
          <h2 className="text-xl font-bold text-gray-300 uppercase tracking-widest text-center mb-4 text-xs drop-shadow-md">All Tools & Sims</h2>
          <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-6">
            {allModes.map(({ mode, label, icon, colors }) => (
                <button 
                  key={mode} 
                  onClick={() => switchMode(mode)} 
                  className={`flex items-center justify-center py-3 px-2 rounded-xl font-semibold text-xs sm:text-sm shadow-lg transition duration-300 ease-in-out transform hover:scale-[1.03] hover:shadow-xl hover:brightness-110 border border-white/10 backdrop-blur-sm ${colors} ${activeMode === mode ? 'ring-4 ring-offset-2 ring-indigo-300 dark:ring-offset-gray-900 dark:ring-indigo-600/70' : ''}`}
                >
                  <div className="flex flex-col items-center gap-1 text-center">
                    {icon}
                    <span>{label}</span>
                  </div>
                </button>
            ))}
          </div>

          <div className="text-center mb-8">
              <p className="text-lg font-serif italic text-yellow-300 drop-shadow-md">
                  "Then you will know the truth, and the truth will set you free."
              </p>
              <p className="text-xs font-bold uppercase tracking-widest text-yellow-300 mt-1 drop-shadow-md">John 8:32</p>
          </div>
       </div>

        <main ref={contentRef} className="bg-white/95 dark:bg-gray-800/95 backdrop-blur-md p-6 sm:p-8 rounded-xl shadow-2xl border border-indigo-100 dark:border-indigo-700 transition-colors duration-300 mb-8 mx-4 sm:mx-0">
          {error && <div className="mt-2 mb-4 p-4 bg-red-100 dark:bg-red-900 border-l-4 border-red-500 text-red-700 dark:text-red-300 rounded-lg"><p className="font-medium">Error:</p><p>{error}</p></div>}
          {loading && <div className="flex justify-center items-center py-8"><svg className="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span className="ml-3 font-semibold text-gray-700 dark:text-gray-300">Generating...</span></div>}
          
          {/* --- RENDER MODES --- */}
          {activeMode === 'guidance' && !loading && (<div><form onSubmit={handleGuidanceSubmit}><label className="block text-lg font-medium mb-2">Describe your situation:</label><div className="relative"><textarea value={situation} onChange={(e) => setSituation(e.target.value)} placeholder="e.g., I'm overwhelmed..." className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700" required /><div className="absolute right-2 bottom-2"><MicButton onTranscript={(text) => setSituation(prev => (prev ? prev + ' ' : '') + text)} /></div></div><button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-indigo-600 text-white rounded-lg">Receive Guidance</button></form>{guidanceResults && <div className="mt-8"><ScriptureSection scriptures={guidanceResults.scriptures} title="Guiding Scriptures" onVerseClick={handleVerseClick}/><PrayerSection prayer={guidanceResults.prayer} onSpeak={handleSpeak} speaking={isSpeaking} /></div>}</div>)}
          {activeMode === 'topic' && !loading && (<div><form onSubmit={handleTopicSubmit}><label className="block text-lg font-medium mb-2">Topic Search:</label><div className="relative"><input type="text" value={topicQuery} onChange={(e) => setTopicQuery(e.target.value)} className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700" required /><div className="absolute right-2 top-2"><MicButton onTranscript={(text) => setTopicQuery(prev => (prev ? prev + ' ' : '') + text)} /></div></div><button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-teal-600 text-white rounded-lg">Search</button></form>{topicResults && <ScriptureSection scriptures={topicResults.scriptures} title={`Scriptures on: ${topicQuery}`} onVerseClick={handleVerseClick}/>}</div>)}
          {activeMode === 'exegetical' && !loading && (<div><form onSubmit={handleExegeticalSubmit}><label className="block text-lg font-medium mb-2">Passage:</label><div className="relative"><input type="text" value={exegeticalInput} onChange={(e) => setExegeticalInput(e.target.value)} className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700" required /><div className="absolute right-2 top-2"><MicButton onTranscript={(text) => setExegeticalInput(prev => (prev ? prev + ' ' : '') + text)} /></div></div><button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-teal-800 text-white rounded-lg">Analyze</button></form><ExegeticalSection results={exegeticalResults} onSpeak={handleSpeak} speaking={isSpeaking}/></div>)}
          {activeMode === 'topical_commentary' && !loading && (<div><form onSubmit={handleTopicalCommentarySubmit}><label className="block text-lg font-medium mb-2">Theological Topic:</label><div className="relative"><input type="text" value={topicalCommentaryInput} onChange={(e) => setTopicalCommentaryInput(e.target.value)} className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700" required /><div className="absolute right-2 top-2"><MicButton onTranscript={(text) => setTopicalCommentaryInput(prev => (prev ? prev + ' ' : '') + text)} /></div></div><button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-sky-600 text-white rounded-lg">Generate Commentary</button></form><TopicalCommentarySection results={topicalCommentaryResults} onVerseClick={handleVerseClick} onSpeak={handleSpeak} speaking={isSpeaking}/></div>)}
          {activeMode === 'literal' && !loading && (<div><form onSubmit={handleLiteralSubmit}><label className="block text-lg font-medium mb-2">Passage for Translation:</label><div className="relative"><input type="text" value={literalInput} onChange={(e) => setLiteralInput(e.target.value)} className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700" required /><div className="absolute right-2 top-2"><MicButton onTranscript={(text) => setLiteralInput(prev => (prev ? prev + ' ' : '') + text)} /></div></div><button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-slate-600 text-white rounded-lg">Translate</button></form><LiteralTranslationSection results={literalResults} onSpeak={handleSpeak} speaking={isSpeaking}/></div>)}
          {activeMode === 'dictionary' && !loading && (<div><form onSubmit={handleDictionarySubmit}><label className="block text-lg font-medium mb-2">Term:</label><div className="relative"><input type="text" value={dictionaryInput} onChange={(e) => setDictionaryInput(e.target.value)} className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700" required /><div className="absolute right-2 top-2"><MicButton onTranscript={(text) => setDictionaryInput(prev => (prev ? prev + ' ' : '') + text)} /></div></div><button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-fuchsia-600 text-white rounded-lg">Look Up</button></form><DictionarySection results={dictionaryResult} onVerseClick={handleVerseClick} onSpeak={handleSpeak} speaking={isSpeaking} onGenerateImage={handleGenerateImage} generatingImage={generatingImage} generatedImage={generatedImage}/></div>)}
          {activeMode === 'parable' && !loading && (<div><form onSubmit={handleParableSubmit}><label className="block text-lg font-medium mb-2">Your Situation:</label><div className="relative"><textarea value={parableInput} onChange={(e) => setParableInput(e.target.value)} className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700" required /><div className="absolute right-2 bottom-2"><MicButton onTranscript={(text) => setParableInput(prev => (prev ? prev + ' ' : '') + text)} /></div></div><button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-amber-600 text-white rounded-lg">Generate Parable</button></form><ParableSection result={parableResult} onSpeak={handleSpeak} speaking={isSpeaking}/></div>)}
          {activeMode === 'apologetics' && !loading && (<div><form onSubmit={handleApologeticsSubmit}><label className="block text-lg font-medium mb-2">Difficult Question:</label><div className="relative"><textarea value={apologeticsInput} onChange={(e) => setApologeticsInput(e.target.value)} className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700" required /><div className="absolute right-2 bottom-2"><MicButton onTranscript={(text) => setApologeticsInput(prev => (prev ? prev + ' ' : '') + text)} /></div></div><button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-blue-800 text-white rounded-lg">Ask Theologian</button></form><ApologeticsSection results={apologeticsResult} onSpeak={handleSpeak} speaking={isSpeaking}/></div>)}
          {activeMode === 'study' && !loading && (<div><form onSubmit={handleStudySubmit}><label className="block text-lg font-medium mb-2">Verses:</label><div className="relative"><textarea value={studyVersesInput} onChange={(e) => setStudyVersesInput(e.target.value)} className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700" required /><div className="absolute right-2 bottom-2"><MicButton onTranscript={(text) => setStudyVersesInput(prev => (prev ? prev + ' ' : '') + text)} /></div></div><button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-orange-600 text-white rounded-lg">Generate Plan</button></form><StudyPlanSection results={studyPlanResults} onVerseClick={handleVerseClick}/></div>)}
          {activeMode === 'children_study' && !loading && (<div><form onSubmit={handleChildrenStudySubmit}><div className="grid grid-cols-3 gap-4 mb-2"><div className="col-span-1 relative"><input type="number" placeholder="Age" value={childrenAgeInput} onChange={(e) => setChildrenAgeInput(e.target.value)} className="w-full p-3 pr-8 border rounded-lg" /><div className="absolute right-1 top-2"><MicButton onTranscript={(text) => setChildrenAgeInput(text)} /></div></div><div className="col-span-2 relative"><input type="text" placeholder="Topic" value={childrenTopicInput} onChange={(e) => setChildrenTopicInput(e.target.value)} className="w-full p-3 pr-10 border rounded-lg" /><div className="absolute right-2 top-2"><MicButton onTranscript={(text) => setChildrenTopicInput(prev => (prev ? prev + ' ' : '') + text)} /></div></div></div><button type="submit" disabled={!isAuthReady} className="w-full mt-2 py-3 bg-green-600 text-white rounded-lg">Generate Lesson</button></form>{childrenStudyResults && <div className="mt-8 p-6 bg-white dark:bg-gray-700 rounded-xl shadow-lg"><div className="text-gray-700 dark:text-gray-300 leading-relaxed">{renderMarkdown(childrenStudyResults)}</div></div>}</div>)}
          {activeMode === 'sermon_outline' && !loading && (<div><form onSubmit={handleSermonSubmit}><label className="block text-lg font-medium mb-2">Topic:</label><div className="relative"><textarea value={sermonInput} onChange={(e) => setSermonInput(e.target.value)} className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700" required /><div className="absolute right-2 bottom-2"><MicButton onTranscript={(text) => setSermonInput(prev => (prev ? prev + ' ' : '') + text)} /></div></div><button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-purple-600 text-white rounded-lg">Generate Outline</button></form><SermonOutlineSection results={sermonResults} onVerseClick={handleVerseClick} onSpeak={handleSpeak} speaking={isSpeaking} onGenerateImage={handleGenerateImage} generatingImage={generatingImage} generatedImage={generatedImage}/></div>)}
          {activeMode === 'spurgeon' && !loading && (<div><form onSubmit={handleSpurgeonSubmit}><label className="block text-lg font-medium mb-2">Topic:</label><div className="relative"><textarea value={spurgeonInput} onChange={(e) => setSpurgeonInput(e.target.value)} className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700" required /><div className="absolute right-2 bottom-2"><MicButton onTranscript={(text) => setSpurgeonInput(prev => (prev ? prev + ' ' : '') + text)} /></div></div><button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-gray-700 text-white rounded-lg">Generate Spurgeon Outline</button></form><SermonOutlineSection results={spurgeonResults} onVerseClick={handleVerseClick} onSpeak={handleSpeak} speaking={isSpeaking} onGenerateImage={handleGenerateImage} generatingImage={generatingImage} generatedImage={generatedImage} isSpurgeon={true}/></div>)}
          {activeMode === 'trivia' && (<div>{!triviaResults && !loading && (<form onSubmit={handleTriviaSubmit}><div className="relative mb-2"><input type="text" value={triviaInput} onChange={(e) => setTriviaInput(e.target.value)} placeholder="Topic (optional)" className="w-full p-3 pr-10 border rounded-lg" /><div className="absolute right-2 top-2"><MicButton onTranscript={(text) => setTriviaInput(prev => (prev ? prev + ' ' : '') + text)} /></div></div><button type="submit" className="w-full py-3 bg-cyan-600 text-white rounded-lg">Start Trivia</button></form>)}{(triviaResults || (activeMode === 'trivia' && loading && triviaResults)) && <TriviaSection results={triviaResults} onVerseClick={handleVerseClick} onNextQuestion={() => handleTriviaSubmit(null)} loadingNext={loading}/>}</div>)}
          {activeMode === 'evangelism' && !loading && (<div>{!evangelismPersona ? (<div className="grid grid-cols-1 md:grid-cols-2 gap-4">{EVANGELISM_PERSONAS.map(p => (<button key={p.id} onClick={() => startEvangelismChat(p.id)} className="p-4 border rounded-xl hover:shadow-lg"><h3 className="font-bold">{p.label}</h3><p className="text-sm">{p.prompt}</p></button>))}</div>) : (<EvangelismSection chatHistory={evangelismChatHistory} persona={evangelismPersona} chatLoading={evangelismLoading} onSend={handleEvangelismSend} onGetHint={handleEvangelismHint} hint={evangelismHint} hintLoading={evangelismHintLoading} onClearHint={() => setEvangelismHint(null)}/>)}</div>)}
          {activeMode === 'custom_prayer' && !loading && (<div><p className="text-center text-gray-500 mb-6">Fill in requests structured by The Lord's Prayer.</p><form onSubmit={handleCustomPrayerSubmit}><div className="space-y-4">{PRAYER_SECTIONS.map((section) => (<div key={section.key} className="relative"><label className="block text-sm font-medium text-pink-600 mb-1">{section.title}</label><textarea rows="2" value={customPrayerInputs[section.key]} onChange={(e) => handlePrayerInputChange(section.key, e.target.value)} className="w-full p-2 pr-10 border rounded-lg text-sm" /><div className="absolute right-2 bottom-2"><MicButton onTranscript={(text) => handlePrayerInputChange(section.key, (customPrayerInputs[section.key] ? customPrayerInputs[section.key] + ' ' : '') + text)} /></div></div>))}</div><button type="submit" className="w-full mt-6 py-3 bg-pink-600 text-white rounded-lg">Generate Prayer</button></form>{generatedPrayer && <div className="mt-8 p-6 bg-yellow-50 border-l-4 border-yellow-500 rounded-xl shadow-lg"><h2 className="text-2xl font-bold text-yellow-800 mb-4">Your Personalized Prayer</h2><p className="text-gray-700 whitespace-pre-line text-lg">{generatedPrayer}<span className="block mt-4 italic font-bold">Amen.</span></p></div>}</div>)}
          {activeMode === 'hymn' && !loading && (<div><form onSubmit={handleHymnSubmit}><label className="block text-lg font-medium mb-2">Song Theme:</label><div className="relative"><input type="text" value={hymnInput} onChange={(e) => setHymnInput(e.target.value)} className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700" required /><div className="absolute right-2 top-2"><MicButton onTranscript={(text) => setHymnInput(prev => (prev ? prev + ' ' : '') + text)} /></div></div><button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-rose-500 text-white rounded-lg">Generate Hymn</button></form><HymnSection result={hymnResult} onSpeak={handleSpeak} speaking={isSpeaking} /></div>)}
          {activeMode === 'symbolism' && !loading && (<div><form onSubmit={handleSymbolismSubmit}><label className="block text-lg font-medium mb-2">Symbol/Dream:</label><div className="relative"><textarea value={symbolismInput} onChange={(e) => setSymbolismInput(e.target.value)} className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700" required /><div className="absolute right-2 bottom-2"><MicButton onTranscript={(text) => setSymbolismInput(prev => (prev ? prev + ' ' : '') + text)} /></div></div><button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-indigo-900 text-white rounded-lg">Analyze</button></form><SymbolismSection result={symbolismResult} /></div>)}
          
          {/* ✨ Character Chat Mode with Custom Input */}
          {activeMode === 'character_chat' && !loading && (
            <div>
                {!selectedCharacter ? (
                    <div className="space-y-6">
                        {/* Custom Character Input */}
                        <div className="bg-amber-50 dark:bg-amber-900/20 p-4 rounded-xl border border-amber-200 dark:border-amber-700">
                            <label className="block text-sm font-bold text-amber-900 dark:text-amber-400 mb-2">Chat with anyone (Custom):</label>
                            <div className="flex gap-2">
                                <div className="relative flex-grow">
                                    <input 
                                        type="text" 
                                        value={customCharInput} 
                                        onChange={(e) => setCustomCharInput(e.target.value)} 
                                        placeholder="e.g., King Herod, Pontius Pilate, The Innkeeper..." 
                                        className="w-full p-2 pr-10 border rounded-lg dark:bg-gray-700 dark:text-white text-sm"
                                    />
                                    <div className="absolute right-2 top-2">
                                        <MicButton onTranscript={(text) => setCustomCharInput(prev => (prev ? prev + ' ' : '') + text)} />
                                    </div>
                                </div>
                                <button 
                                    onClick={() => {
                                        if(!customCharInput.trim()) return;
                                        startCharacterChat({
                                            id: 'custom',
                                            label: customCharInput,
                                            prompt: `You are ${customCharInput} from the Bible. Speak in the first person. Be concise.`
                                        });
                                    }} 
                                    className="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap"
                                >
                                    Start Chat
                                </button>
                            </div>
                        </div>

                        {/* Presets Grid - Compact */}
                        <div>
                            <h3 className="text-sm font-bold text-gray-500 uppercase tracking-widest mb-3">Popular Characters</h3>
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                                {BIBLICAL_CHARACTERS.map(c => (
                                    <button 
                                        key={c.id} 
                                        onClick={() => startCharacterChat(c)} 
                                        className="p-2 border rounded-lg hover:shadow-md hover:bg-amber-50 dark:hover:bg-gray-700 transition text-left flex items-center justify-between group"
                                    >
                                        <span className="font-bold text-xs text-gray-800 dark:text-gray-200 group-hover:text-amber-700 dark:group-hover:text-amber-400 truncate">{c.label}</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-3 w-3 text-gray-400 group-hover:text-amber-500 opacity-0 group-hover:opacity-100 transition-opacity" viewBox="0 0 20 20" fill="currentColor">
                                            <path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd" />
                                        </svg>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                ) : (
                    <CharacterChatSection chatHistory={characterChatHistory} character={selectedCharacter} chatLoading={characterLoading} onSend={handleCharacterSend} />
                )}
            </div>
          )}

          {/* --- NEW MODES RENDER --- */}
          {activeMode === 'metaphor' && !loading && (
            <div>
              <form onSubmit={handleMetaphorSubmit}>
                <label className="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Theological Concept:</label>
                <div className="relative">
                    <input type="text" value={metaphorInput} onChange={(e) => setMetaphorInput(e.target.value)} placeholder="e.g., The Trinity, Justification, Grace" className="w-full p-3 pr-10 border-2 border-violet-200 dark:bg-gray-700 dark:border-violet-600 dark:text-white rounded-lg focus:ring-violet-500 transition duration-150" required />
                    <div className="absolute right-2 top-2">
                        <MicButton onTranscript={(text) => setMetaphorInput(prev => (prev ? prev + ' ' : '') + text)} />
                    </div>
                </div>
                <button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-violet-600 hover:bg-violet-700 text-white rounded-lg shadow-lg font-bold">Generate Analogies</button>
              </form>
              <MetaphorSection result={metaphorResult} />
            </div>
          )}

          {activeMode === 'quiet_time' && !loading && (
            <div>
              <form onSubmit={handleQuietTimeSubmit}>
                <div className="grid grid-cols-2 gap-4">
                   <div>
                     <label className="block text-sm font-medium mb-1">Time Available (mins):</label>
                     <select value={quietTimeDuration} onChange={(e) => setQuietTimeDuration(e.target.value)} className="w-full p-3 border rounded-lg dark:bg-gray-700 dark:text-white">
                        <option value="5">5 Minutes</option>
                        <option value="10">10 Minutes</option>
                        <option value="15">15 Minutes</option>
                        <option value="30">30 Minutes</option>
                        <option value="60">60 Minutes</option>
                     </select>
                   </div>
                   <div>
                     <label className="block text-sm font-medium mb-1">Current Mood:</label>
                     <div className="relative">
                        <input type="text" value={quietTimeMood} onChange={(e) => setQuietTimeMood(e.target.value)} placeholder="e.g., Anxious, Grateful" className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700 dark:text-white" />
                        <div className="absolute right-2 top-2">
                            <MicButton onTranscript={(text) => setQuietTimeMood(prev => (prev ? prev + ' ' : '') + text)} />
                        </div>
                     </div>
                   </div>
                </div>
                <button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg shadow-lg font-bold">Build Routine</button>
              </form>
              <QuietTimeSection result={quietTimeResult} />
            </div>
          )}

          {activeMode === 'debate' && !loading && (
            <div>
              <form onSubmit={handleDebateSubmit}>
                <div className="space-y-4">
                   <div>
                     <label className="block text-sm font-medium mb-1">Topic:</label>
                     <div className="relative">
                        <input type="text" value={debateTopic} onChange={(e) => setDebateTopic(e.target.value)} placeholder="e.g., Faith vs Works, Predestination" className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700 dark:text-white" required />
                        <div className="absolute right-2 top-2">
                            <MicButton onTranscript={(text) => setDebateTopic(prev => (prev ? prev + ' ' : '') + text)} />
                        </div>
                     </div>
                   </div>
                   <div>
                     <label className="block text-sm font-medium mb-1">Participants (Pick 2):</label>
                     <div className="relative">
                        <input type="text" value={debateParticipants} onChange={(e) => setDebateParticipants(e.target.value)} placeholder="e.g., Paul and James, Calvin and Arminius" className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700 dark:text-white" required />
                        <div className="absolute right-2 top-2">
                            <MicButton onTranscript={(text) => setDebateParticipants(prev => (prev ? prev + ' ' : '') + text)} />
                        </div>
                     </div>
                   </div>
                </div>
                <button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-gray-800 hover:bg-black text-white rounded-lg shadow-lg font-bold">Simulate Dialogue</button>
              </form>
              <DebateSection result={debateResult} />
            </div>
          )}

          {activeMode === 'memorization' && !loading && (
             <div>
                <form onSubmit={handleMemorySubmit}>
                   <label className="block text-lg font-medium text-lime-900 dark:text-lime-200 mb-2">Verse to Memorize:</label>
                   <div className="relative">
                        <input type="text" value={memoryInput} onChange={(e) => setMemoryInput(e.target.value)} placeholder="e.g., John 3:16, Psalm 23:1" className="w-full p-3 border-2 pr-10 border-lime-200 dark:bg-gray-700 dark:border-lime-700 dark:text-white rounded-lg focus:ring-lime-500" required />
                        <div className="absolute right-2 top-2">
                            <MicButton onTranscript={(text) => setMemoryInput(prev => (prev ? prev + ' ' : '') + text)} />
                        </div>
                   </div>
                   <button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-lime-600 hover:bg-lime-700 text-white rounded-lg shadow-lg font-bold">Get Coach</button>
                </form>
                <MemorizationSection result={memoryResult} />
             </div>
          )}

          {activeMode === 'name_gen' && !loading && (
             <div>
                <form onSubmit={handleNameSubmit}>
                   <label className="block text-lg font-medium text-fuchsia-900 dark:text-fuchsia-200 mb-2">Desired Meaning or Theme:</label>
                   <div className="relative">
                        <input type="text" value={nameInput} onChange={(e) => setNameInput(e.target.value)} placeholder="e.g., Strength, Peace, Gift of God" className="w-full p-3 border-2 pr-10 border-fuchsia-200 dark:bg-gray-700 dark:border-fuchsia-700 dark:text-white rounded-lg focus:ring-fuchsia-500" required />
                        <div className="absolute right-2 top-2">
                            <MicButton onTranscript={(text) => setNameInput(prev => (prev ? prev + ' ' : '') + text)} />
                        </div>
                   </div>
                   <button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-fuchsia-700 hover:bg-fuchsia-800 text-white rounded-lg shadow-lg font-bold">Find Names</button>
                </form>
                <NameGeneratorSection result={nameResult} />
             </div>
          )}

          {activeMode === 'event_planner' && !loading && (
             <div>
                <form onSubmit={handleEventSubmit}>
                   <div className="grid md:grid-cols-2 gap-4">
                      <div>
                         <label className="block text-sm font-medium mb-1">Event Type:</label>
                         <div className="relative">
                            <input type="text" value={eventTypeInput} onChange={(e) => setEventTypeInput(e.target.value)} placeholder="e.g., Youth Lock-in, Men's Breakfast" className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700 dark:text-white" required />
                            <div className="absolute right-2 top-2">
                                <MicButton onTranscript={(text) => setEventTypeInput(prev => (prev ? prev + ' ' : '') + text)} />
                            </div>
                         </div>
                      </div>
                      <div>
                         <label className="block text-sm font-medium mb-1">Main Theme/Idea:</label>
                         <div className="relative">
                            <input type="text" value={eventInput} onChange={(e) => setEventInput(e.target.value)} placeholder="e.g., Unity, Missions, Summer Kickoff" className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700 dark:text-white" required />
                            <div className="absolute right-2 top-2">
                                <MicButton onTranscript={(text) => setEventInput(prev => (prev ? prev + ' ' : '') + text)} />
                            </div>
                         </div>
                      </div>
                   </div>
                   <button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-cyan-700 hover:bg-cyan-800 text-white rounded-lg shadow-lg font-bold">Plan Event</button>
                </form>
                <EventPlannerSection result={eventResult} />
             </div>
          )}

          {/* ✨ Bible Story Remix */}
          {activeMode === 'remix' && !loading && (
             <div>
                <form onSubmit={handleRemixSubmit}>
                   <div className="space-y-4">
                       <div>
                         <label className="block text-lg font-medium text-purple-900 dark:text-purple-300 mb-2">Bible Story:</label>
                         <div className="relative">
                            <input type="text" value={remixInput} onChange={(e) => setRemixInput(e.target.value)} placeholder="e.g., David and Goliath, The Good Samaritan" className="w-full p-3 border-2 pr-10 border-purple-300 dark:bg-gray-700 dark:border-purple-600 dark:text-white rounded-lg focus:ring-purple-500" required />
                            <div className="absolute right-2 top-2">
                                <MicButton onTranscript={(text) => setRemixInput(prev => (prev ? prev + ' ' : '') + text)} />
                            </div>
                         </div>
                       </div>
                       <div>
                         <label className="block text-sm font-medium mb-2">Choose or Type a Style:</label>
                         <div className="flex flex-wrap gap-2 mb-3">
                            {REMIX_STYLES.map(style => (
                               <button 
                                 type="button" 
                                 key={style} 
                                 onClick={() => setRemixStyle(style)}
                                 className={`px-3 py-1 rounded-full text-xs font-bold transition-all border ${remixStyle === style ? 'bg-purple-600 text-white border-purple-600' : 'bg-white text-gray-600 border-gray-300 hover:border-purple-400'}`}
                               >
                                 {style}
                               </button>
                            ))}
                         </div>
                         <div className="relative">
                            <input 
                                type="text" 
                                value={remixStyle} 
                                onChange={(e) => setRemixStyle(e.target.value)} 
                                placeholder="Or type your own style (e.g. 1920s Gangster, Haiku)..." 
                                className="w-full p-3 border rounded-lg dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-purple-500 outline-none transition-all"
                            />
                            <div className="absolute right-2 top-2">
                                <MicButton onTranscript={(text) => setRemixStyle(prev => (prev ? prev + ' ' : '') + text)} />
                            </div>
                         </div>
                       </div>
                   </div>
                   <button type="submit" disabled={!isAuthReady} className="w-full mt-6 py-3 bg-purple-800 hover:bg-purple-900 text-white rounded-lg shadow-lg font-bold flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                     Remix Story
                   </button>
                </form>
                <StoryRemixSection result={remixResult} />
             </div>
          )}

          {/* ✨ Conflict Resolver */}
          {activeMode === 'conflict' && !loading && (
             <div>
                <form onSubmit={handleConflictSubmit}>
                   <label className="block text-lg font-medium text-blue-900 dark:text-blue-300 mb-2">Describe the Conflict:</label>
                   <div className="relative">
                        <textarea rows="4" value={conflictInput} onChange={(e) => setConflictInput(e.target.value)} placeholder="e.g., I had a heated argument with my spouse about finances and we haven't spoken all day..." className="w-full p-3 border-2 pr-10 border-blue-200 dark:bg-gray-700 dark:border-blue-700 dark:text-white rounded-lg focus:ring-blue-500" required />
                        <div className="absolute right-2 bottom-2">
                            <MicButton onTranscript={(text) => setConflictInput(prev => (prev ? prev + ' ' : '') + text)} />
                        </div>
                   </div>
                   <button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-lg font-bold flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01m-4.5 5.5h.01m-4.5 5.5h.01M12 21.75c-4.97 0-9-4.03-9-9s4.03-9 9-9 9 4.03 9 9-4.03 9-9 9z" /></svg>
                     Find Biblical Peace
                   </button>
                </form>
                <ConflictMediatorSection result={conflictResult} />
             </div>
          )}

          {/* ✨ Proverb Interpreter */}
          {activeMode === 'proverb' && !loading && (
             <div>
                <form onSubmit={handleProverbSubmit}>
                   <label className="block text-lg font-medium text-amber-900 dark:text-amber-400 mb-2">Proverb or Wisdom Saying:</label>
                   <div className="relative">
                        <input type="text" value={proverbInput} onChange={(e) => setProverbInput(e.target.value)} placeholder="e.g., Proverbs 27:17, or 'Iron sharpens iron'" className="w-full p-3 border-2 pr-10 border-amber-200 dark:bg-gray-700 dark:border-amber-700 dark:text-white rounded-lg focus:ring-amber-500 transition duration-150" required />
                        <div className="absolute right-2 top-2">
                            <MicButton onTranscript={(text) => setProverbInput(prev => (prev ? prev + ' ' : '') + text)} />
                        </div>
                   </div>
                   <button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg shadow-lg font-bold flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" /></svg>
                     Unlock Wisdom
                   </button>
                </form>
                <ProverbSection result={proverbResult} />
             </div>
          )}
          
          {/* ✨ NEW: Epistle Writer */}
          {activeMode === 'epistle' && !loading && (
             <div>
                <form onSubmit={handleEpistleSubmit}>
                   <div className="grid md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium mb-1">Recipient Name:</label>
                        <div className="relative">
                            <input type="text" value={epistleRecipient} onChange={(e) => setEpistleRecipient(e.target.value)} placeholder="e.g., Aunt Sarah" className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700 dark:text-white" required />
                            <div className="absolute right-2 top-2">
                                <MicButton onTranscript={(text) => setEpistleRecipient(prev => (prev ? prev + ' ' : '') + text)} />
                            </div>
                        </div>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Occasion/Need:</label>
                        <div className="relative">
                            <input type="text" value={epistleOccasion} onChange={(e) => setEpistleOccasion(e.target.value)} placeholder="e.g., Loss of a job, Birthday, Recovering from surgery" className="w-full p-3 pr-10 border rounded-lg dark:bg-gray-700 dark:text-white" required />
                            <div className="absolute right-2 top-2">
                                <MicButton onTranscript={(text) => setEpistleOccasion(prev => (prev ? prev + ' ' : '') + text)} />
                            </div>
                        </div>
                      </div>
                   </div>
                   <button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-rose-600 hover:bg-rose-700 text-white rounded-lg shadow-lg font-bold flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                     Write Encouragement
                   </button>
                </form>
                <EpistleSection result={epistleResult} />
             </div>
          )}

          {/* ✨ NEW: Sermon Illustrator */}
          {activeMode === 'illustration' && !loading && (
             <div>
                <form onSubmit={handleIllustrationSubmit}>
                   <label className="block text-lg font-medium text-teal-900 dark:text-teal-300 mb-2">Theological Concept to Illustrate:</label>
                   <div className="relative">
                        <input type="text" value={illustrationInput} onChange={(e) => setIllustrationInput(e.target.value)} placeholder="e.g., Redemption, Sacrifice, Faith vs Sight" className="w-full p-3 pr-10 border-2 border-teal-200 dark:bg-gray-700 dark:border-teal-700 dark:text-white rounded-lg focus:ring-teal-500" required />
                        <div className="absolute right-2 top-2">
                            <MicButton onTranscript={(text) => setIllustrationInput(prev => (prev ? prev + ' ' : '') + text)} />
                        </div>
                   </div>
                   <button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-teal-600 hover:bg-teal-700 text-white rounded-lg shadow-lg font-bold flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                     Find Illustrations
                   </button>
                </form>
                <IllustrationSection result={illustrationResult} />
             </div>
          )}
          
          {/* ✨ NEW: Biblical Timeline */}
          {activeMode === 'timeline' && !loading && (
             <div>
                <form onSubmit={handleTimelineSubmit}>
                   <label className="block text-lg font-medium text-slate-900 dark:text-slate-300 mb-2">Character or Era:</label>
                   <div className="relative">
                        <input type="text" value={timelineInput} onChange={(e) => setTimelineInput(e.target.value)} placeholder="e.g., King David, The Exodus, The Life of Paul" className="w-full p-3 pr-10 border-2 border-slate-300 dark:bg-gray-700 dark:border-slate-600 dark:text-white rounded-lg focus:ring-slate-500" required />
                        <div className="absolute right-2 top-2">
                            <MicButton onTranscript={(text) => setTimelineInput(prev => (prev ? prev + ' ' : '') + text)} />
                        </div>
                   </div>
                   <button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-slate-600 hover:bg-slate-700 text-white rounded-lg shadow-lg font-bold flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                     Generate Timeline
                   </button>
                </form>
                <TimelineSection result={timelineResult} />
             </div>
          )}
          
          {/* ✨ NEW: Chapter Summarizer */}
          {activeMode === 'summary' && !loading && (
             <div>
                <form onSubmit={handleSummarySubmit}>
                   <label className="block text-lg font-medium text-orange-900 dark:text-orange-300 mb-2">Chapter or Passage to Summarize:</label>
                   <div className="relative">
                        <input type="text" value={summaryInput} onChange={(e) => setSummaryInput(e.target.value)} placeholder="e.g., Romans 8, Psalm 23, The Sermon on the Mount" className="w-full p-3 pr-10 border-2 border-orange-200 dark:bg-gray-700 dark:border-orange-600 dark:text-white rounded-lg focus:ring-orange-500" required />
                        <div className="absolute right-2 top-2">
                            <MicButton onTranscript={(text) => setSummaryInput(prev => (prev ? prev + ' ' : '') + text)} />
                        </div>
                   </div>
                   <button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-orange-700 hover:bg-orange-800 text-white rounded-lg shadow-lg font-bold flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                     Summarize Chapter
                   </button>
                </form>
                <ChapterSummarySection result={summaryResult} />
             </div>
          )}

          {/* ✨ NEW: Gem Finder */}
          {activeMode === 'gem_finder' && !loading && (
             <div>
                <form onSubmit={handleGemFinderSubmit}>
                   <div className="grid md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-lg font-medium text-fuchsia-900 dark:text-fuchsia-300 mb-2">Author/Preacher:</label>
                        <div className="relative">
                            <input type="text" value={gemNameInput} onChange={(e) => setGemNameInput(e.target.value)} placeholder="e.g., C.S. Lewis, Charles Spurgeon, Martin Luther" className="w-full p-3 pr-10 border-2 border-fuchsia-200 dark:bg-gray-700 dark:border-fuchsia-600 dark:text-white rounded-lg focus:ring-fuchsia-500" required />
                            <div className="absolute right-2 top-2">
                                <MicButton onTranscript={(text) => setGemNameInput(prev => (prev ? prev + ' ' : '') + text)} />
                            </div>
                        </div>
                      </div>
                      <div>
                        <label className="block text-lg font-medium text-fuchsia-900 dark:text-fuchsia-300 mb-2">Reference/Chapter:</label>
                        <div className="relative">
                            <input type="text" value={gemReferenceInput} onChange={(e) => setGemReferenceInput(e.target.value)} placeholder="e.g., Psalm 23, The Beatitudes, John 3:16" className="w-full p-3 pr-10 border-2 border-fuchsia-200 dark:bg-gray-700 dark:border-fuchsia-600 dark:text-white rounded-lg focus:ring-fuchsia-500" required />
                            <div className="absolute right-2 top-2">
                                <MicButton onTranscript={(text) => setGemReferenceInput(prev => (prev ? prev + ' ' : '') + text)} />
                            </div>
                        </div>
                      </div>
                   </div>
                   <button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-fuchsia-600 hover:bg-fuchsia-700 text-white rounded-lg shadow-lg font-bold flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>
                     Find Spiritual Gems
                   </button>
                </form>
                <GemFinderSection result={gemResult} />
             </div>
          )}

          {/* ✨ NEW: Interlinear Bible */}
          {activeMode === 'interlinear' && !loading && (
             <div>
                <form onSubmit={handleInterlinearSubmit}>
                   <label className="block text-lg font-medium text-stone-900 dark:text-stone-300 mb-2">Verse(s) to Analyze:</label>
                   <div className="relative">
                        <input type="text" value={interlinearInput} onChange={(e) => setInterlinearInput(e.target.value)} placeholder="e.g., John 1:1, Romans 8:28, Genesis 1:1" className="w-full p-3 pr-10 border-2 border-stone-300 dark:bg-gray-700 dark:border-stone-600 dark:text-white rounded-lg focus:ring-stone-500" required />
                        <div className="absolute right-2 top-2">
                            <MicButton onTranscript={(text) => setInterlinearInput(prev => (prev ? prev + ' ' : '') + text)} />
                        </div>
                   </div>
                   <button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-stone-600 hover:bg-stone-700 text-white rounded-lg shadow-lg font-bold flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.247m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.247"/><path strokeLinecap="round" strokeLinejoin="round" d="M9 21h6m-6 0v-2m6 2v-2m-6 0h6"/></svg>
                     Generate Interlinear
                   </button>
                </form>
                <InterlinearSection result={interlinearResult} />
             </div>
          )}

          {/* ✨ NEW: Youth Group Planner */}
          {activeMode === 'youth_planner' && !loading && (
             <div>
                <form onSubmit={handleYouthGroupSubmit}>
                   <div className="mb-4">
                      <label className="block text-lg font-medium text-sky-900 dark:text-sky-300 mb-2">Base Plan On:</label>
                      <div className="flex space-x-4 mb-2">
                         <button 
                            type="button" 
                            onClick={() => setYouthInputType('topic')}
                            className={`flex-1 py-2 px-4 rounded-lg font-bold transition-all border-2 ${youthInputType === 'topic' ? 'bg-sky-600 border-sky-600 text-white' : 'bg-white border-gray-300 text-gray-600 hover:border-sky-400'}`}
                         >
                            Topic / Theme
                         </button>
                         <button 
                            type="button" 
                            onClick={() => setYouthInputType('verse')}
                            className={`flex-1 py-2 px-4 rounded-lg font-bold transition-all border-2 ${youthInputType === 'verse' ? 'bg-sky-600 border-sky-600 text-white' : 'bg-white border-gray-300 text-gray-600 hover:border-sky-400'}`}
                         >
                            Bible Verse
                         </button>
                      </div>
                   </div>

                   <label className="block text-lg font-medium text-sky-900 dark:text-sky-300 mb-2">
                      {youthInputType === 'topic' ? 'Enter Topic:' : 'Enter Verse Reference:'}
                   </label>
                   <div className="relative">
                        <input 
                            type="text" 
                            value={youthInput} 
                            onChange={(e) => setYouthInput(e.target.value)} 
                            placeholder={youthInputType === 'topic' ? "e.g., Identity, Friendship, Social Media" : "e.g., 1 Timothy 4:12, Jeremiah 29:11"} 
                            className="w-full p-3 pr-10 border-2 border-sky-300 dark:bg-gray-700 dark:border-sky-600 dark:text-white rounded-lg focus:ring-sky-500" 
                            required 
                        />
                        <div className="absolute right-2 top-2">
                            <MicButton onTranscript={(text) => setYouthInput(prev => (prev ? prev + ' ' : '') + text)} />
                        </div>
                   </div>
                   <button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-sky-500 hover:bg-sky-600 text-white rounded-lg shadow-lg font-bold flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                     Plan Youth Meeting
                   </button>
                </form>
                <YouthGroupPlannerSection result={youthResult} />
             </div>
          )}

          {/* ✨ NEW: Types of Christ */}
          {activeMode === 'types_of_christ' && !loading && (
             <div>
                <form onSubmit={handleTypesSubmit}>
                   <label className="block text-lg font-medium text-amber-900 dark:text-amber-400 mb-2">Search Topic (Optional):</label>
                   <div className="relative">
                        <input 
                            type="text" 
                            value={typesInput} 
                            onChange={(e) => setTypesInput(e.target.value)} 
                            placeholder="e.g., Joseph, Passover, or leave blank for top examples" 
                            className="w-full p-3 pr-10 border-2 border-amber-300 dark:bg-gray-700 dark:border-amber-600 dark:text-white rounded-lg focus:ring-amber-500" 
                        />
                        <div className="absolute right-2 top-2">
                            <MicButton onTranscript={(text) => setTypesInput(prev => (prev ? prev + ' ' : '') + text)} />
                        </div>
                   </div>
                   <button type="submit" disabled={!isAuthReady} className="w-full mt-4 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-lg shadow-lg font-bold flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                     Reveal Shadows & Substance
                   </button>
                </form>
                <TypesOfChristSection result={typesResult} />
             </div>
          )}

        </main>
        
        {/* Suggested Resources Section */}
        <div className="max-w-4xl mx-auto mb-8 px-4 text-center">
            <h3 className="text-xl font-bold text-white uppercase tracking-widest mb-4 drop-shadow-md">Suggested Study Resources</h3>
            <div className="flex flex-wrap justify-center gap-4 sm:gap-6">
                {USEFUL_LINKS.map((link) => (
                    <a 
                        key={link.name} 
                        href={link.url} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="text-yellow-300 hover:text-yellow-100 text-base sm:text-lg font-bold transition-colors hover:underline drop-shadow-md"
                    >
                        {link.name}
                    </a>
                ))}
            </div>
        </div>

        {/* Footer */}
        <footer className="text-center text-gray-500 dark:text-gray-400 text-xs pb-8">
           <p>© {new Date().getFullYear()} Study Buddy. All rights reserved.</p>
           <p className="mt-1">Built with Gemini 2.5 Flash Preview</p>
        </footer>

        {/* Modal for Bible Context */}
        <BibleViewerModal 
            viewerState={viewerState} 
            onClose={handleModalClose} 
            loading={viewerLoading} 
            fullChapterText={fullChapterText} 
        />
      </div>
    </div>
  );
};

export default App;
